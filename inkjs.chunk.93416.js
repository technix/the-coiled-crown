(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{JOws:function(t,e){function n(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var i,r,a,o,s=[],u=!0,l=!1;try{if(a=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;u=!1}else for(;!(u=(i=a.call(n)).done)&&(s.push(i.value),s.length!==e);u=!0);}catch(t){l=!0,r=t}finally{try{if(!u&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(l)throw r}}return s}}(t,e)||d(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&h(t,e)}function r(t){var e=l();return function(){var n,i=c(t);if(e){var r=c(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return a(this,n)}}function a(t,e){if(e&&("object"===g(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return o(t)}function o(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function s(t){var e="function"==typeof Map?new Map:void 0;return s=function(t){function n(){return u(t,arguments,c(this).constructor)}if(null===t||-1===Function.toString.call(t).indexOf("[native code]"))return t;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,n)}return n.prototype=Object.create(t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),h(n,t)},s(t)}function u(t,e,n){return u=l()?Reflect.construct.bind():function(t,e,n){var i=[null];i.push.apply(i,e);var r=new(Function.bind.apply(t,i));return n&&h(r,n.prototype),r},u.apply(null,arguments)}function l(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}function h(t,e){return h=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},h(t,e)}function c(t){return c=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},c(t)}function f(t){return function(t){if(Array.isArray(t))return p(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||d(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function v(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=d(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0,r=function(){};return{s:r,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return o=t.done,t},e:function(t){s=!0,a=t},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function d(t,e){if(t){if("string"==typeof t)return p(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?p(t,e):void 0}}function p(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function y(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,(r=void 0,r=function(t,e){if("object"!==g(t)||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var i=n.call(t,e||"default");if("object"!==g(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(i.key,"string"),"symbol"===g(r)?r:String(r)),i)}var r}function m(t,e,n){return e&&y(t.prototype,e),n&&y(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function g(t){return g="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},g(t)}var S,k,C;C=function(t){"use strict";function e(t,e){return t instanceof e?t:null}function u(t,e){if(t instanceof e)return t;throw new Error("".concat(t," is not of type ").concat(e))}function l(t){return t.hasValidName&&t.name?t:null}function h(t){return void 0===t?null:t}function c(t){return"object"==g(t)&&"function"==typeof t.Equals}function d(t){throw new w("".concat(t," is null or undefined"))}function p(t,e,n){if(null===t)return{result:n,exists:!1};var i=t.get(e);return void 0===i?{result:n,exists:!1}:{result:i,exists:!0}}var y,S,k,C,b=function(){function t(){if(this._components=[],this._componentsString=null,this._isRelative=!1,"string"==typeof arguments[0])this.componentsString=arguments[0];else if(arguments[0]instanceof t.Component&&arguments[1]instanceof t){var e=arguments[1];this._components.push(arguments[0]),this._components=this._components.concat(e._components)}else if(arguments[0]instanceof Array){var n=!!arguments[1];this._components=this._components.concat(arguments[0]),this._isRelative=n}}return m(t,[{key:"isRelative",get:function(){return this._isRelative}},{key:"componentCount",get:function(){return this._components.length}},{key:"head",get:function(){return this._components.length>0?this._components[0]:null}},{key:"tail",get:function(){return this._components.length>=2?new t(this._components.slice(1,this._components.length)):t.self}},{key:"length",get:function(){return this._components.length}},{key:"lastComponent",get:function(){var t=this._components.length-1;return t>=0?this._components[t]:null}},{key:"containsNamedComponent",get:function(){for(var t=0,e=this._components.length;t<e;t++)if(!this._components[t].isIndex)return!0;return!1}},{key:"GetComponent",value:function(t){return this._components[t]}},{key:"PathByAppendingPath",value:function(e){for(var n=new t,i=0,r=0;r<e._components.length&&e._components[r].isParent;++r)i++;for(var a=0;a<this._components.length-i;++a)n._components.push(this._components[a]);for(var o=i;o<e._components.length;++o)n._components.push(e._components[o]);return n}},{key:"componentsString",get:function(){return null==this._componentsString&&(this._componentsString=this._components.join("."),this.isRelative&&(this._componentsString="."+this._componentsString)),this._componentsString},set:function(e){if(this._components.length=0,this._componentsString=e,null!=this._componentsString&&""!=this._componentsString){"."==this._componentsString[0]&&(this._isRelative=!0,this._componentsString=this._componentsString.substring(1));var n,i=v(this._componentsString.split("."));try{for(i.s();!(n=i.n()).done;){var r=n.value;/^(\-|\+)?([0-9]+|Infinity)$/.test(r)?this._components.push(new t.Component(parseInt(r))):this._components.push(new t.Component(r))}}catch(t){i.e(t)}finally{i.f()}}}},{key:"toString",value:function(){return this.componentsString}},{key:"Equals",value:function(t){if(null==t)return!1;if(t._components.length!=this._components.length)return!1;if(t.isRelative!=this.isRelative)return!1;for(var e=0,n=t._components.length;e<n;e++)if(!t._components[e].Equals(this._components[e]))return!1;return!0}},{key:"PathByAppendingComponent",value:function(e){var n,i=new t;return(n=i._components).push.apply(n,f(this._components)),i._components.push(e),i}}],[{key:"self",get:function(){var e=new t;return e._isRelative=!0,e}}]),t}();b.parentId="^",function(t){t.Component=function(){function e(t){this.index=-1,this.name=null,"string"==typeof t?this.name=t:this.index=t}return m(e,[{key:"isIndex",get:function(){return this.index>=0}},{key:"isParent",get:function(){return this.name==t.parentId}},{key:"toString",value:function(){return this.isIndex?this.index.toString():this.name}},{key:"Equals",value:function(t){return null!=t&&t.isIndex==this.isIndex&&(this.isIndex?this.index==t.index:this.name==t.name)}}],[{key:"ToParent",value:function(){return new e(t.parentId)}}]),e}()}(b||(b={})),function(t){function e(t,e){if(!t)throw void 0!==e&&console.warn(e),console.trace&&console.trace(),new Error("")}t.AssertType=function(t,n,i){e(t instanceof n,i)},t.Assert=e}(y||(y={}));var w=function(t){function e(){return n.apply(this,arguments)}i(e,t);var n=r(e);return m(e)}(s(Error)),_=function(){function t(){this.parent=null,this._debugMetadata=null,this._path=null}return m(t,[{key:"debugMetadata",get:function(){return null===this._debugMetadata&&this.parent?this.parent.debugMetadata:this._debugMetadata},set:function(t){this._debugMetadata=t}},{key:"ownDebugMetadata",get:function(){return this._debugMetadata}},{key:"DebugLineNumberOfPath",value:function(t){if(null===t)return null;var e=this.rootContentContainer;if(e){var n=e.ContentAtPath(t).obj;if(n){var i=n.debugMetadata;if(null!==i)return i.startLineNumber}}return null}},{key:"path",get:function(){if(null==this._path)if(null==this.parent)this._path=new b;else{for(var t=[],n=this,i=e(n.parent,D);null!==i;){var r=l(n);if(null!=r&&r.hasValidName){if(null===r.name)return d("namedChild.name");t.unshift(new b.Component(r.name))}else t.unshift(new b.Component(i.content.indexOf(n)));n=i,i=e(i.parent,D)}this._path=new b(t)}return this._path}},{key:"ResolvePath",value:function(t){if(null===t)return d("path");if(t.isRelative){var n=e(this,D);return null===n&&(y.Assert(null!==this.parent,"Can't resolve relative path because we don't have a parent"),n=e(this.parent,D),y.Assert(null!==n,"Expected parent to be a container"),y.Assert(t.GetComponent(0).isParent),t=t.tail),null===n?d("nearestContainer"):n.ContentAtPath(t)}var i=this.rootContentContainer;return null===i?d("contentContainer"):i.ContentAtPath(t)}},{key:"ConvertPathToRelative",value:function(t){for(var e=this.path,n=Math.min(t.length,e.length),i=-1,r=0;r<n;++r){var a=e.GetComponent(r),o=t.GetComponent(r);if(!a.Equals(o))break;i=r}if(-1==i)return t;for(var s=e.componentCount-1-i,u=[],l=0;l<s;++l)u.push(b.Component.ToParent());for(var h=i+1;h<t.componentCount;++h)u.push(t.GetComponent(h));return new b(u,!0)}},{key:"CompactPathString",value:function(t){var e=null,n=null;return t.isRelative?(n=t.componentsString,e=this.path.PathByAppendingPath(t).componentsString):(n=this.ConvertPathToRelative(t).componentsString,e=t.componentsString),n.length<e.length?n:e}},{key:"rootContentContainer",get:function(){for(var t=this;t.parent;)t=t.parent;return e(t,D)}},{key:"Copy",value:function(){throw Error("Not Implemented: Doesn't support copying")}},{key:"SetChild",value:function(t,e,n){t[e]&&(t[e]=null),t[e]=n,t[e]&&(t[e].parent=this)}},{key:"Equals",value:function(t){return t===this}}]),t}(),T=function(){function t(t){t=void 0!==t?t.toString():"",this.string=t}return m(t,[{key:"Length",get:function(){return this.string.length}},{key:"Append",value:function(t){null!==t&&(this.string+=t)}},{key:"AppendLine",value:function(t){void 0!==t&&this.Append(t),this.string+="\n"}},{key:"AppendFormat",value:function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];this.string+=t.replace(/{(\d+)}/g,(function(t,e){return void 0!==n[e]?n[e]:t}))}},{key:"toString",value:function(){return this.string}},{key:"Clear",value:function(){this.string=""}}]),t}(),E=function(){function t(){if(this.originName=null,this.itemName=null,void 0!==arguments[1]){var t=arguments[1];this.originName=arguments[0],this.itemName=t}else if(arguments[0]){var e=arguments[0].toString().split(".");this.originName=e[0],this.itemName=e[1]}}return m(t,[{key:"isNull",get:function(){return null==this.originName&&null==this.itemName}},{key:"fullName",get:function(){return(null!==this.originName?this.originName:"?")+"."+this.itemName}},{key:"toString",value:function(){return this.fullName}},{key:"Equals",value:function(e){return e instanceof t&&(e.itemName==this.itemName&&e.originName==this.originName)}},{key:"copy",value:function(){return new t(this.originName,this.itemName)}},{key:"serialized",value:function(){return JSON.stringify({originName:this.originName,itemName:this.itemName})}}],[{key:"Null",get:function(){return new t(null,null)}},{key:"fromSerializedKey",value:function(e){var n=JSON.parse(e);return t.isLikeInkListItem(n)?new t(n.originName,n.itemName):t.Null}},{key:"isLikeInkListItem",value:function(t){return!("object"!=g(t)||!t.hasOwnProperty("originName")||!t.hasOwnProperty("itemName")||"string"!=typeof t.originName&&null!==g(t.originName)||"string"!=typeof t.itemName&&null!==g(t.itemName))}}]),t}(),O=function(t){function e(){var t;if((t=o.call(this,arguments[0]instanceof e?arguments[0]:[])).origins=null,t._originNames=[],arguments[0]instanceof e){var n=arguments[0],i=n.originNames;null!==i&&(t._originNames=i.slice()),null!==n.origins&&(t.origins=n.origins.slice())}else if("string"==typeof arguments[0]){var r=arguments[0],s=arguments[1];if(t.SetInitialOriginName(r),null===s.listDefinitions)return a(t,d("originStory.listDefinitions"));var u=s.listDefinitions.TryListGetDefinition(r,null);if(!u.exists)throw new Error("InkList origin could not be found in story when constructing new list: "+r);if(null===u.result)return a(t,d("def.result"));t.origins=[u.result]}else if("object"==g(arguments[0])&&arguments[0].hasOwnProperty("Key")&&arguments[0].hasOwnProperty("Value")){var l=arguments[0];t.Add(l.Key,l.Value)}return a(t)}i(e,t);var o=r(e);return m(e,[{key:"AddItem",value:function(t){if(t instanceof E){var e=t;if(null==e.originName)return void this.AddItem(e.itemName);if(null===this.origins)return d("this.origins");var n,i=v(this.origins);try{for(i.s();!(n=i.n()).done;){var r=n.value;if(r.name==e.originName){var a=r.TryGetValueForItem(e,0);if(a.exists)return void this.Add(e,a.result);throw new Error("Could not add the item "+e+" to this list because it doesn't exist in the original list definition in ink.")}}}catch(t){i.e(t)}finally{i.f()}throw new Error("Failed to add item to list because the item was from a new list definition that wasn't previously known to this list. Only items from previously known lists can be used, so that the int value can be found.")}var o=t,s=null;if(null===this.origins)return d("this.origins");var u,l=v(this.origins);try{for(l.s();!(u=l.n()).done;){var h=u.value;if(null===o)return d("itemName");if(h.ContainsItemWithName(o)){if(null!=s)throw new Error("Could not add the item "+o+" to this list because it could come from either "+h.name+" or "+s.name);s=h}}}catch(t){l.e(t)}finally{l.f()}if(null==s)throw new Error("Could not add the item "+o+" to this list because it isn't known to any list definitions previously associated with this list.");var c=new E(s.name,o),f=s.ValueForItem(c);this.Add(c,f)}},{key:"ContainsItemNamed",value:function(t){var e,i=v(this);try{for(i.s();!(e=i.n()).done;){var r=n(e.value,1);if(E.fromSerializedKey(r[0]).itemName==t)return!0}}catch(t){i.e(t)}finally{i.f()}return!1}},{key:"ContainsKey",value:function(t){return this.has(t.serialized())}},{key:"Add",value:function(t,e){var n=t.serialized();if(this.has(n))throw new Error("The Map already contains an entry for ".concat(t));this.set(n,e)}},{key:"Remove",value:function(t){return this.delete(t.serialized())}},{key:"Count",get:function(){return this.size}},{key:"originOfMaxItem",get:function(){if(null==this.origins)return null;var t=this.maxItem.Key.originName,e=null;return this.origins.every((function(n){return n.name!=t||(e=n,!1)})),e}},{key:"originNames",get:function(){if(this.Count>0){null==this._originNames&&this.Count>0?this._originNames=[]:(this._originNames||(this._originNames=[]),this._originNames.length=0);var t,e=v(this);try{for(e.s();!(t=e.n()).done;){var i=n(t.value,1),r=E.fromSerializedKey(i[0]);if(null===r.originName)return d("item.originName");this._originNames.push(r.originName)}}catch(t){e.e(t)}finally{e.f()}}return this._originNames}},{key:"SetInitialOriginName",value:function(t){this._originNames=[t]}},{key:"SetInitialOriginNames",value:function(t){this._originNames=null==t?null:t.slice()}},{key:"maxItem",get:function(){var t,e={Key:E.Null,Value:0},i=v(this);try{for(i.s();!(t=i.n()).done;){var r=n(t.value,2),a=r[1],o=E.fromSerializedKey(r[0]);(e.Key.isNull||a>e.Value)&&(e={Key:o,Value:a})}}catch(t){i.e(t)}finally{i.f()}return e}},{key:"minItem",get:function(){var t,e={Key:E.Null,Value:0},i=v(this);try{for(i.s();!(t=i.n()).done;){var r=n(t.value,2),a=r[1],o=E.fromSerializedKey(r[0]);(e.Key.isNull||a<e.Value)&&(e={Key:o,Value:a})}}catch(t){i.e(t)}finally{i.f()}return e}},{key:"inverse",get:function(){var t=new e;if(null!=this.origins){var i,r=v(this.origins);try{for(r.s();!(i=r.n()).done;){var a,o=v(i.value.items);try{for(o.s();!(a=o.n()).done;){var s=n(a.value,2),u=s[1],l=E.fromSerializedKey(s[0]);this.ContainsKey(l)||t.Add(l,u)}}catch(t){o.e(t)}finally{o.f()}}}catch(t){r.e(t)}finally{r.f()}}return t}},{key:"all",get:function(){var t=new e;if(null!=this.origins){var i,r=v(this.origins);try{for(r.s();!(i=r.n()).done;){var a,o=v(i.value.items);try{for(o.s();!(a=o.n()).done;){var s=n(a.value,2),u=s[1],l=E.fromSerializedKey(s[0]);t.set(l.serialized(),u)}}catch(t){o.e(t)}finally{o.f()}}}catch(t){r.e(t)}finally{r.f()}}return t}},{key:"Union",value:function(t){var i,r=new e(this),a=v(t);try{for(a.s();!(i=a.n()).done;){var o=n(i.value,2);r.set(o[0],o[1])}}catch(t){a.e(t)}finally{a.f()}return r}},{key:"Intersect",value:function(t){var i,r=new e,a=v(this);try{for(a.s();!(i=a.n()).done;){var o=n(i.value,2),s=o[0],u=o[1];t.has(s)&&r.set(s,u)}}catch(t){a.e(t)}finally{a.f()}return r}},{key:"HasIntersection",value:function(t){var e,i=v(this);try{for(i.s();!(e=i.n()).done;){var r=n(e.value,1);if(t.has(r[0]))return!0}}catch(t){i.e(t)}finally{i.f()}return!1}},{key:"Without",value:function(t){var i,r=new e(this),a=v(t);try{for(a.s();!(i=a.n()).done;){var o=n(i.value,1);r.delete(o[0])}}catch(t){a.e(t)}finally{a.f()}return r}},{key:"Contains",value:function(t){if("string"==typeof t)return this.ContainsItemNamed(t);if(0==t.size||0==this.size)return!1;var e,i=v(t);try{for(i.s();!(e=i.n()).done;){var r=n(e.value,1);if(!this.has(r[0]))return!1}}catch(t){i.e(t)}finally{i.f()}return!0}},{key:"GreaterThan",value:function(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>t.maxItem.Value)}},{key:"GreaterThanOrEquals",value:function(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>=t.minItem.Value&&this.maxItem.Value>=t.maxItem.Value)}},{key:"LessThan",value:function(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<t.minItem.Value)}},{key:"LessThanOrEquals",value:function(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<=t.maxItem.Value&&this.minItem.Value<=t.minItem.Value)}},{key:"MaxAsList",value:function(){return this.Count>0?new e(this.maxItem):new e}},{key:"MinAsList",value:function(){return this.Count>0?new e(this.minItem):new e}},{key:"ListWithSubRange",value:function(t,n){if(0==this.Count)return new e;var i=this.orderedItems,r=0,a=Number.MAX_SAFE_INTEGER;Number.isInteger(t)?r=t:t instanceof e&&t.Count>0&&(r=t.minItem.Value),Number.isInteger(n)?a=n:n instanceof e&&n.Count>0&&(a=n.maxItem.Value);var o=new e;o.SetInitialOriginNames(this.originNames);var s,u=v(i);try{for(u.s();!(s=u.n()).done;){var l=s.value;l.Value>=r&&l.Value<=a&&o.Add(l.Key,l.Value)}}catch(t){u.e(t)}finally{u.f()}return o}},{key:"Equals",value:function(t){if(t instanceof e==0)return!1;if(t.Count!=this.Count)return!1;var i,r=v(this);try{for(r.s();!(i=r.n()).done;){var a=n(i.value,1);if(!t.has(a[0]))return!1}}catch(t){r.e(t)}finally{r.f()}return!0}},{key:"orderedItems",get:function(){var t,e=new Array,i=v(this);try{for(i.s();!(t=i.n()).done;){var r=n(t.value,2),a=r[1],o=E.fromSerializedKey(r[0]);e.push({Key:o,Value:a})}}catch(t){i.e(t)}finally{i.f()}return e.sort((function(t,e){return null===t.Key.originName?d("x.Key.originName"):null===e.Key.originName?d("y.Key.originName"):t.Value==e.Value?t.Key.originName.localeCompare(e.Key.originName):t.Value<e.Value?-1:t.Value>e.Value?1:0})),e}},{key:"toString",value:function(){for(var t=this.orderedItems,e=new T,n=0;n<t.length;n++){n>0&&e.Append(", ");var i=t[n].Key;if(null===i.itemName)return d("item.itemName");e.Append(i.itemName)}return e.toString()}},{key:"valueOf",value:function(){return NaN}}],[{key:"FromString",value:function(t,n){var i,r=null===(i=n.listDefinitions)||void 0===i?void 0:i.FindSingleItemListWithName(t);if(r)return null===r.value?d("listValue.value"):new e(r.value);throw new Error("Could not find the InkListItem from the string '"+t+"' to create an InkList because it doesn't exist in the original list definition in ink.")}}]),e}(s(Map)),P=function(t){function e(t){var e;return(e=n.call(this,t)).useEndLineNumber=!1,e.message=t,e.name="StoryException",e}i(e,t);var n=r(e);return m(e)}(s(Error)),N=function(t){function e(){return n.apply(this,arguments)}i(e,t);var n=r(e);return m(e,[{key:"Copy",value:function(){return u(e.Create(this.valueObject),_)}},{key:"BadCastException",value:function(t){return new P("Can't cast "+this.valueObject+" from "+this.valueType+" to "+t)}}],[{key:"Create",value:function(t,e){if(e){if(e===S.Int&&Number.isInteger(Number(t)))return new F(Number(t));if(e===S.Float&&!isNaN(t))return new x(Number(t))}return"boolean"==typeof t?new I(Boolean(t)):"string"==typeof t?new W(String(t)):Number.isInteger(Number(t))?new F(Number(t)):isNaN(t)?t instanceof b?new V(u(t,b)):t instanceof O?new j(u(t,O)):null:new x(Number(t))}}]),e}(_),A=function(t){function e(t){var e;return(e=n.call(this)).value=t,e}i(e,t);var n=r(e);return m(e,[{key:"valueObject",get:function(){return this.value}},{key:"toString",value:function(){return null===this.value?d("Value.value"):this.value.toString()}}]),e}(N),I=function(t){function e(t){return n.call(this,t||!1)}i(e,t);var n=r(e);return m(e,[{key:"isTruthy",get:function(){return Boolean(this.value)}},{key:"valueType",get:function(){return S.Bool}},{key:"Cast",value:function(t){if(null===this.value)return d("Value.value");if(t==this.valueType)return this;if(t==S.Int)return new F(this.value?1:0);if(t==S.Float)return new x(this.value?1:0);if(t==S.String)return new W(this.value?"true":"false");throw this.BadCastException(t)}},{key:"toString",value:function(){return this.value?"true":"false"}}]),e}(A),F=function(t){function e(t){return n.call(this,t||0)}i(e,t);var n=r(e);return m(e,[{key:"isTruthy",get:function(){return 0!=this.value}},{key:"valueType",get:function(){return S.Int}},{key:"Cast",value:function(t){if(null===this.value)return d("Value.value");if(t==this.valueType)return this;if(t==S.Bool)return new I(0!==this.value);if(t==S.Float)return new x(this.value);if(t==S.String)return new W(""+this.value);throw this.BadCastException(t)}}]),e}(A),x=function(t){function e(t){return n.call(this,t||0)}i(e,t);var n=r(e);return m(e,[{key:"isTruthy",get:function(){return 0!=this.value}},{key:"valueType",get:function(){return S.Float}},{key:"Cast",value:function(t){if(null===this.value)return d("Value.value");if(t==this.valueType)return this;if(t==S.Bool)return new I(0!==this.value);if(t==S.Int)return new F(this.value);if(t==S.String)return new W(""+this.value);throw this.BadCastException(t)}}]),e}(A),W=function(t){function e(t){var e;return(e=n.call(this,t||""))._isNewline="\n"==e.value,e._isInlineWhitespace=!0,null===e.value?a(e,d("Value.value")):(e.value.length>0&&e.value.split("").every((function(t){return" "==t||"\t"==t||(e._isInlineWhitespace=!1,!1)})),a(e))}i(e,t);var n=r(e);return m(e,[{key:"valueType",get:function(){return S.String}},{key:"isTruthy",get:function(){return null===this.value?d("Value.value"):this.value.length>0}},{key:"isNewline",get:function(){return this._isNewline}},{key:"isInlineWhitespace",get:function(){return this._isInlineWhitespace}},{key:"isNonWhitespace",get:function(){return!this.isNewline&&!this.isInlineWhitespace}},{key:"Cast",value:function(t){if(t==this.valueType)return this;if(t==S.Int){var e=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=parseInt(t);return Number.isNaN(n)?{result:e,exists:!1}:{result:n,exists:!0}}(this.value);if(e.exists)return new F(e.result);throw this.BadCastException(t)}if(t==S.Float){var n=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=parseFloat(t);return Number.isNaN(n)?{result:e,exists:!1}:{result:n,exists:!0}}(this.value);if(n.exists)return new x(n.result);throw this.BadCastException(t)}throw this.BadCastException(t)}}]),e}(A),V=function(t){function e(){return n.call(this,arguments.length>0&&void 0!==arguments[0]?arguments[0]:null)}i(e,t);var n=r(e);return m(e,[{key:"valueType",get:function(){return S.DivertTarget}},{key:"targetPath",get:function(){return null===this.value?d("Value.value"):this.value},set:function(t){this.value=t}},{key:"isTruthy",get:function(){throw new Error("Shouldn't be checking the truthiness of a divert target")}},{key:"Cast",value:function(t){if(t==this.valueType)return this;throw this.BadCastException(t)}},{key:"toString",value:function(){return"DivertTargetValue("+this.targetPath+")"}}]),e}(A),L=function(t){function e(t){var e,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;return(e=n.call(this,t))._contextIndex=i,e}i(e,t);var n=r(e);return m(e,[{key:"contextIndex",get:function(){return this._contextIndex},set:function(t){this._contextIndex=t}},{key:"variableName",get:function(){return null===this.value?d("Value.value"):this.value},set:function(t){this.value=t}},{key:"valueType",get:function(){return S.VariablePointer}},{key:"isTruthy",get:function(){throw new Error("Shouldn't be checking the truthiness of a variable pointer")}},{key:"Cast",value:function(t){if(t==this.valueType)return this;throw this.BadCastException(t)}},{key:"toString",value:function(){return"VariablePointerValue("+this.variableName+")"}},{key:"Copy",value:function(){return new e(this.variableName,this.contextIndex)}}]),e}(A),j=function(t){function n(t,e){var n;return n=a.call(this,null),t||e?t instanceof O?n.value=new O(t):t instanceof E&&"number"==typeof e&&(n.value=new O({Key:t,Value:e})):n.value=new O,n}i(n,t);var a=r(n);return m(n,[{key:"isTruthy",get:function(){return null===this.value?d("this.value"):this.value.Count>0}},{key:"valueType",get:function(){return S.List}},{key:"Cast",value:function(t){if(null===this.value)return d("Value.value");if(t==S.Int){var e=this.value.maxItem;return new F(e.Key.isNull?0:e.Value)}if(t==S.Float){var n=this.value.maxItem;return new x(n.Key.isNull?0:n.Value)}if(t==S.String){var i=this.value.maxItem;return new W(i.Key.isNull?"":i.Key.toString())}if(t==this.valueType)return this;throw this.BadCastException(t)}}],[{key:"RetainListOriginsForAssignment",value:function(t,i){var r=e(t,n),a=e(i,n);return a&&null===a.value?d("newList.value"):r&&null===r.value?d("oldList.value"):void(r&&a&&0==a.value.Count&&a.value.SetInitialOriginNames(r.value.originNames))}}]),n}(A);!function(t){t[t.Bool=-1]="Bool",t[t.Int=0]="Int",t[t.Float=1]="Float",t[t.List=2]="List",t[t.String=3]="String",t[t.DivertTarget=4]="DivertTarget",t[t.VariablePointer=5]="VariablePointer"}(S||(S={}));var R=function(){function t(){this.obj=null,this.approximate=!1}return m(t,[{key:"correctObj",get:function(){return this.approximate?null:this.obj}},{key:"container",get:function(){return this.obj instanceof D?this.obj:null}},{key:"copy",value:function(){var e=new t;return e.obj=this.obj,e.approximate=this.approximate,e}}]),t}(),D=function(t){function a(){var t;return(t=o.apply(this,arguments)).name=null,t._content=[],t.namedContent=new Map,t.visitsShouldBeCounted=!1,t.turnIndexShouldBeCounted=!1,t.countingAtStartOnly=!1,t._pathToFirstLeafContent=null,t}i(a,t);var o=r(a);return m(a,[{key:"hasValidName",get:function(){return null!=this.name&&this.name.length>0}},{key:"content",get:function(){return this._content},set:function(t){this.AddContent(t)}},{key:"namedOnlyContent",get:function(){var t,e=new Map,i=v(this.namedContent);try{for(i.s();!(t=i.n()).done;){var r=n(t.value,2),a=r[0],o=u(r[1],_);e.set(a,o)}}catch(t){i.e(t)}finally{i.f()}var s,h=v(this.content);try{for(h.s();!(s=h.n()).done;){var c=l(s.value);null!=c&&c.hasValidName&&e.delete(c.name)}}catch(t){h.e(t)}finally{h.f()}return 0==e.size&&(e=null),e},set:function(t){var e=this.namedOnlyContent;if(null!=e){var i,r=v(e);try{for(r.s();!(i=r.n()).done;){var a=n(i.value,1);this.namedContent.delete(a[0])}}catch(t){r.e(t)}finally{r.f()}}if(null!=t){var o,s=v(t);try{for(s.s();!(o=s.n()).done;){var u=l(n(o.value,2)[1]);null!=u&&this.AddToNamedContentOnly(u)}}catch(t){s.e(t)}finally{s.f()}}}},{key:"countFlags",get:function(){var t=0;return this.visitsShouldBeCounted&&(t|=a.CountFlags.Visits),this.turnIndexShouldBeCounted&&(t|=a.CountFlags.Turns),this.countingAtStartOnly&&(t|=a.CountFlags.CountStartOnly),t==a.CountFlags.CountStartOnly&&(t=0),t},set:function(t){var e=t;(e&a.CountFlags.Visits)>0&&(this.visitsShouldBeCounted=!0),(e&a.CountFlags.Turns)>0&&(this.turnIndexShouldBeCounted=!0),(e&a.CountFlags.CountStartOnly)>0&&(this.countingAtStartOnly=!0)}},{key:"pathToFirstLeafContent",get:function(){return null==this._pathToFirstLeafContent&&(this._pathToFirstLeafContent=this.path.PathByAppendingPath(this.internalPathToFirstLeafContent)),this._pathToFirstLeafContent}},{key:"internalPathToFirstLeafContent",get:function(){for(var t=[],e=this;e instanceof a;)e.content.length>0&&(t.push(new b.Component(0)),e=e.content[0]);return new b(t)}},{key:"AddContent",value:function(t){if(t instanceof Array){var e,n=v(t);try{for(n.s();!(e=n.n()).done;)this.AddContent(e.value)}catch(t){n.e(t)}finally{n.f()}}else{var i=t;if(this._content.push(i),i.parent)throw new Error("content is already in "+i.parent);i.parent=this,this.TryAddNamedContent(i)}}},{key:"TryAddNamedContent",value:function(t){var e=l(t);null!=e&&e.hasValidName&&this.AddToNamedContentOnly(e)}},{key:"AddToNamedContentOnly",value:function(t){if(y.AssertType(t,_,"Can only add Runtime.Objects to a Runtime.Container"),u(t,_).parent=this,null===t.name)return d("namedContentObj.name");this.namedContent.set(t.name,t)}},{key:"ContentAtPath",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1;-1==i&&(i=t.length);var r=new R;r.approximate=!1;for(var o=this,s=this,u=n;u<i;++u){var l=t.GetComponent(u);if(null==o){r.approximate=!0;break}var h=o.ContentWithPathComponent(l);if(null==h){r.approximate=!0;break}s=h,o=e(h,a)}return r.obj=s,r}},{key:"InsertContent",value:function(t,e){if(this.content.splice(e,0,t),t.parent)throw new Error("content is already in "+t.parent);t.parent=this,this.TryAddNamedContent(t)}},{key:"AddContentsOfContainer",value:function(t){var e;(e=this.content).push.apply(e,f(t.content));var n,i=v(t.content);try{for(i.s();!(n=i.n()).done;){var r=n.value;r.parent=this,this.TryAddNamedContent(r)}}catch(t){i.e(t)}finally{i.f()}}},{key:"ContentWithPathComponent",value:function(t){if(t.isIndex)return t.index>=0&&t.index<this.content.length?this.content[t.index]:null;if(t.isParent)return this.parent;if(null===t.name)return d("component.name");var e=p(this.namedContent,t.name,null);return e.exists?u(e.result,_):null}},{key:"BuildStringOfHierarchy",value:function(){function t(){for(var t=0;t<4*i;++t)e.Append(" ")}var e;if(0==arguments.length)return e=new T,this.BuildStringOfHierarchy(e,0,null),e.toString();e=arguments[0];var i=arguments[1],r=arguments[2];t(),e.Append("["),this.hasValidName&&e.AppendFormat(" ({0})",this.name),this==r&&e.Append("  <---"),e.AppendLine(),i++;for(var o=0;o<this.content.length;++o){var s=this.content[o];s instanceof a?s.BuildStringOfHierarchy(e,i,r):(t(),s instanceof W?(e.Append('"'),e.Append(s.toString().replace("\n","\\n")),e.Append('"')):e.Append(s.toString())),o!=this.content.length-1&&e.Append(","),s instanceof a||s!=r||e.Append("  <---"),e.AppendLine()}var l,h=new Map,c=v(this.namedContent);try{for(c.s();!(l=c.n()).done;){var f=n(l.value,2),d=f[0],p=f[1];this.content.indexOf(u(p,_))>=0||h.set(d,p)}}catch(t){c.e(t)}finally{c.f()}if(h.size>0){t(),e.AppendLine("-- named: --");var m,g=v(h);try{for(g.s();!(m=g.n()).done;){var S=n(m.value,2)[1];y.AssertType(S,a,"Can only print out named Containers"),S.BuildStringOfHierarchy(e,i,r),e.AppendLine()}}catch(t){g.e(t)}finally{g.f()}}i--,t(),e.Append("]")}}]),a}(_);!function(t){var e;(e=t.CountFlags||(t.CountFlags={}))[e.Visits=1]="Visits",e[e.Turns=2]="Turns",e[e.CountStartOnly=4]="CountStartOnly"}(D||(D={}));var B=function(t){function e(){return n.apply(this,arguments)}i(e,t);var n=r(e);return m(e,[{key:"toString",value:function(){return"Glue"}}]),e}(_),G=function(t){function e(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e.CommandType.NotSet;return(t=n.call(this))._commandType=i,t}i(e,t);var n=r(e);return m(e,[{key:"commandType",get:function(){return this._commandType}},{key:"Copy",value:function(){return new e(this.commandType)}},{key:"toString",value:function(){return this.commandType.toString()}}],[{key:"EvalStart",value:function(){return new e(e.CommandType.EvalStart)}},{key:"EvalOutput",value:function(){return new e(e.CommandType.EvalOutput)}},{key:"EvalEnd",value:function(){return new e(e.CommandType.EvalEnd)}},{key:"Duplicate",value:function(){return new e(e.CommandType.Duplicate)}},{key:"PopEvaluatedValue",value:function(){return new e(e.CommandType.PopEvaluatedValue)}},{key:"PopFunction",value:function(){return new e(e.CommandType.PopFunction)}},{key:"PopTunnel",value:function(){return new e(e.CommandType.PopTunnel)}},{key:"BeginString",value:function(){return new e(e.CommandType.BeginString)}},{key:"EndString",value:function(){return new e(e.CommandType.EndString)}},{key:"NoOp",value:function(){return new e(e.CommandType.NoOp)}},{key:"ChoiceCount",value:function(){return new e(e.CommandType.ChoiceCount)}},{key:"Turns",value:function(){return new e(e.CommandType.Turns)}},{key:"TurnsSince",value:function(){return new e(e.CommandType.TurnsSince)}},{key:"ReadCount",value:function(){return new e(e.CommandType.ReadCount)}},{key:"Random",value:function(){return new e(e.CommandType.Random)}},{key:"SeedRandom",value:function(){return new e(e.CommandType.SeedRandom)}},{key:"VisitIndex",value:function(){return new e(e.CommandType.VisitIndex)}},{key:"SequenceShuffleIndex",value:function(){return new e(e.CommandType.SequenceShuffleIndex)}},{key:"StartThread",value:function(){return new e(e.CommandType.StartThread)}},{key:"Done",value:function(){return new e(e.CommandType.Done)}},{key:"End",value:function(){return new e(e.CommandType.End)}},{key:"ListFromInt",value:function(){return new e(e.CommandType.ListFromInt)}},{key:"ListRange",value:function(){return new e(e.CommandType.ListRange)}},{key:"ListRandom",value:function(){return new e(e.CommandType.ListRandom)}},{key:"BeginTag",value:function(){return new e(e.CommandType.BeginTag)}},{key:"EndTag",value:function(){return new e(e.CommandType.EndTag)}}]),e}(_);!function(t){var e;(e=t.CommandType||(t.CommandType={}))[e.NotSet=-1]="NotSet",e[e.EvalStart=0]="EvalStart",e[e.EvalOutput=1]="EvalOutput",e[e.EvalEnd=2]="EvalEnd",e[e.Duplicate=3]="Duplicate",e[e.PopEvaluatedValue=4]="PopEvaluatedValue",e[e.PopFunction=5]="PopFunction",e[e.PopTunnel=6]="PopTunnel",e[e.BeginString=7]="BeginString",e[e.EndString=8]="EndString",e[e.NoOp=9]="NoOp",e[e.ChoiceCount=10]="ChoiceCount",e[e.Turns=11]="Turns",e[e.TurnsSince=12]="TurnsSince",e[e.ReadCount=13]="ReadCount",e[e.Random=14]="Random",e[e.SeedRandom=15]="SeedRandom",e[e.VisitIndex=16]="VisitIndex",e[e.SequenceShuffleIndex=17]="SequenceShuffleIndex",e[e.StartThread=18]="StartThread",e[e.Done=19]="Done",e[e.End=20]="End",e[e.ListFromInt=21]="ListFromInt",e[e.ListRange=22]="ListRange",e[e.ListRandom=23]="ListRandom",e[e.BeginTag=24]="BeginTag",e[e.EndTag=25]="EndTag",e[e.TOTAL_VALUES=26]="TOTAL_VALUES"}(G||(G={})),function(t){t[t.Tunnel=0]="Tunnel",t[t.Function=1]="Function",t[t.FunctionEvaluationFromGame=2]="FunctionEvaluationFromGame"}(k||(k={}));var M=function(){function t(){this.container=null,this.index=-1,2===arguments.length&&(this.container=arguments[0],this.index=arguments[1])}return m(t,[{key:"Resolve",value:function(){return this.index<0?this.container:null==this.container?null:0==this.container.content.length?this.container:this.index>=this.container.content.length?null:this.container.content[this.index]}},{key:"isNull",get:function(){return null==this.container}},{key:"path",get:function(){return this.isNull?null:this.index>=0?this.container.path.PathByAppendingComponent(new b.Component(this.index)):this.container.path}},{key:"toString",value:function(){return this.container?"Ink Pointer -> "+this.container.path.toString()+" -- index "+this.index:"Ink Pointer (null)"}},{key:"copy",value:function(){return new t(this.container,this.index)}}],[{key:"StartOf",value:function(e){return new t(e,0)}},{key:"Null",get:function(){return new t(null,-1)}}]),t}(),J=function(t){function e(t){var e;return(e=n.call(this))._targetPath=null,e._targetPointer=M.Null,e.variableDivertName=null,e.pushesToStack=!1,e.stackPushType=0,e.isExternal=!1,e.externalArgs=0,e.isConditional=!1,e.pushesToStack=!1,void 0!==t&&(e.pushesToStack=!0,e.stackPushType=t),e}i(e,t);var n=r(e);return m(e,[{key:"targetPath",get:function(){if(null!=this._targetPath&&this._targetPath.isRelative){var t=this.targetPointer.Resolve();t&&(this._targetPath=t.path)}return this._targetPath},set:function(t){this._targetPath=t,this._targetPointer=M.Null}},{key:"targetPointer",get:function(){if(this._targetPointer.isNull){var t=this.ResolvePath(this._targetPath).obj;if(null===this._targetPath)return d("this._targetPath");if(null===this._targetPath.lastComponent)return d("this._targetPath.lastComponent");if(this._targetPath.lastComponent.isIndex){if(null===t)return d("targetObj");this._targetPointer.container=t.parent instanceof D?t.parent:null,this._targetPointer.index=this._targetPath.lastComponent.index}else this._targetPointer=M.StartOf(t instanceof D?t:null)}return this._targetPointer.copy()}},{key:"targetPathString",get:function(){return null==this.targetPath?null:this.CompactPathString(this.targetPath)},set:function(t){this.targetPath=null==t?null:new b(t)}},{key:"hasVariableTarget",get:function(){return null!=this.variableDivertName}},{key:"Equals",value:function(t){var n=t;return n instanceof e&&this.hasVariableTarget==n.hasVariableTarget&&(this.hasVariableTarget?this.variableDivertName==n.variableDivertName:null===this.targetPath?d("this.targetPath"):this.targetPath.Equals(n.targetPath))}},{key:"toString",value:function(){if(this.hasVariableTarget)return"Divert(variable: "+this.variableDivertName+")";if(null==this.targetPath)return"Divert(null)";var t=new T,e=this.targetPath.toString();return t.Append("Divert"),this.isConditional&&t.Append("?"),this.pushesToStack&&t.Append(this.stackPushType==k.Function?" function":" tunnel"),t.Append(" -> "),t.Append(this.targetPathString),t.Append(" ("),t.Append(e),t.Append(")"),t.toString()}}]),e}(_),U=function(t){function e(){var t,e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return(t=n.call(this))._pathOnChoice=null,t.hasCondition=!1,t.hasStartContent=!1,t.hasChoiceOnlyContent=!1,t.isInvisibleDefault=!1,t.onceOnly=!0,t.onceOnly=e,t}i(e,t);var n=r(e);return m(e,[{key:"pathOnChoice",get:function(){if(null!=this._pathOnChoice&&this._pathOnChoice.isRelative){var t=this.choiceTarget;t&&(this._pathOnChoice=t.path)}return this._pathOnChoice},set:function(t){this._pathOnChoice=t}},{key:"choiceTarget",get:function(){return null===this._pathOnChoice?d("ChoicePoint._pathOnChoice"):this.ResolvePath(this._pathOnChoice).container}},{key:"pathStringOnChoice",get:function(){return null===this.pathOnChoice?d("ChoicePoint.pathOnChoice"):this.CompactPathString(this.pathOnChoice)},set:function(t){this.pathOnChoice=new b(t)}},{key:"flags",get:function(){var t=0;return this.hasCondition&&(t|=1),this.hasStartContent&&(t|=2),this.hasChoiceOnlyContent&&(t|=4),this.isInvisibleDefault&&(t|=8),this.onceOnly&&(t|=16),t},set:function(t){this.hasCondition=(1&t)>0,this.hasStartContent=(2&t)>0,this.hasChoiceOnlyContent=(4&t)>0,this.isInvisibleDefault=(8&t)>0,this.onceOnly=(16&t)>0}},{key:"toString",value:function(){return null===this.pathOnChoice?d("ChoicePoint.pathOnChoice"):"Choice: -> "+this.pathOnChoice.toString()}}]),e}(_),q=function(t){function e(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return(t=n.call(this)).pathForCount=null,t.name=e,t}i(e,t);var n=r(e);return m(e,[{key:"containerForCount",get:function(){return null===this.pathForCount?null:this.ResolvePath(this.pathForCount).container}},{key:"pathStringForCount",get:function(){return null===this.pathForCount?null:this.CompactPathString(this.pathForCount)},set:function(t){this.pathForCount=null===t?null:new b(t)}},{key:"toString",value:function(){return null!=this.name?"var("+this.name+")":"read_count("+this.pathStringForCount+")"}}]),e}(_),K=function(t){function e(t,e){var i;return(i=n.call(this)).variableName=t||null,i.isNewDeclaration=!!e,i.isGlobal=!1,i}i(e,t);var n=r(e);return m(e,[{key:"toString",value:function(){return"VarAssign to "+this.variableName}}]),e}(_),z=function(t){function e(){return n.apply(this,arguments)}i(e,t);var n=r(e);return m(e)}(_),H=function(t){function o(){var t;if((t=s.call(this))._name=null,t._numberOfParameters=0,t._prototype=null,t._isPrototype=!1,t._operationFuncs=null,0===arguments.length)o.GenerateNativeFunctionsIfNecessary();else if(1===arguments.length){var e=arguments[0];o.GenerateNativeFunctionsIfNecessary(),t.name=e}else if(2===arguments.length){var n=arguments[0],i=arguments[1];t._isPrototype=!0,t.name=n,t.numberOfParameters=i}return a(t)}i(o,t);var s=r(o);return m(o,[{key:"name",get:function(){return null===this._name?d("NativeFunctionCall._name"):this._name},set:function(t){this._name=t,this._isPrototype||(null===o._nativeFunctions?d("NativeFunctionCall._nativeFunctions"):this._prototype=o._nativeFunctions.get(this._name)||null)}},{key:"numberOfParameters",get:function(){return this._prototype?this._prototype.numberOfParameters:this._numberOfParameters},set:function(t){this._numberOfParameters=t}},{key:"Call",value:function(t){if(this._prototype)return this._prototype.Call(t);if(this.numberOfParameters!=t.length)throw new Error("Unexpected number of parameters");var e,n=!1,i=v(t);try{for(i.s();!(e=i.n()).done;){var r=e.value;if(r instanceof z)throw new P('Attempting to perform operation on a void value. Did you forget to "return" a value from a function you called here?');r instanceof j&&(n=!0)}}catch(t){i.e(t)}finally{i.f()}if(2==t.length&&n)return this.CallBinaryListOperation(t);var a=this.CoerceValuesToSingleType(t),o=a[0].valueType;return o==S.Int||o==S.Float||o==S.String||o==S.DivertTarget||o==S.List?this.CallType(a):null}},{key:"CallType",value:function(t){var e=u(t[0],A),n=e.valueType,i=e,r=t.length;if(2==r||1==r){if(null===this._operationFuncs)return d("NativeFunctionCall._operationFuncs");var a=this._operationFuncs.get(n);if(!a)throw new P("Cannot perform operation "+this.name+" on "+S[n]);if(2==r){var s=u(t[1],A),l=a;if(null===i.value||null===s.value)return d("NativeFunctionCall.Call BinaryOp values");var h=l(i.value,s.value);return A.Create(h)}var c=a;if(null===i.value)return d("NativeFunctionCall.Call UnaryOp value");var f=c(i.value);return A.Create(f,this.name===o.Int?S.Int:this.name===o.Float?S.Float:e.valueType)}throw new Error("Unexpected number of parameters to NativeFunctionCall: "+t.length)}},{key:"CallBinaryListOperation",value:function(t){if(("+"==this.name||"-"==this.name)&&t[0]instanceof j&&t[1]instanceof F)return this.CallListIncrementOperation(t);var e=u(t[0],A),n=u(t[1],A);if(!("&&"!=this.name&&"||"!=this.name||e.valueType==S.List&&n.valueType==S.List)){if(null===this._operationFuncs)return d("NativeFunctionCall._operationFuncs");var i=this._operationFuncs.get(S.Int);if(null===i)return d("NativeFunctionCall.CallBinaryListOperation op");var r=function(t){if("boolean"==typeof t)return t;throw new Error("".concat(t," is not a boolean"))}(i(e.isTruthy?1:0,n.isTruthy?1:0));return new I(r)}if(e.valueType==S.List&&n.valueType==S.List)return this.CallType([e,n]);throw new P("Can not call use "+this.name+" operation on "+S[e.valueType]+" and "+S[n.valueType])}},{key:"CallListIncrementOperation",value:function(t){var e=u(t[0],j),i=u(t[1],F),r=new O;if(null===e.value)return d("NativeFunctionCall.CallListIncrementOperation listVal.value");var a,o=v(e.value);try{for(o.s();!(a=o.n()).done;){var s=n(a.value,2),l=s[1],h=E.fromSerializedKey(s[0]);if(null===this._operationFuncs)return d("NativeFunctionCall._operationFuncs");var c=this._operationFuncs.get(S.Int);if(null===i.value)return d("NativeFunctionCall.CallListIncrementOperation intVal.value");var f=c(l,i.value),p=null;if(null===e.value.origins)return d("NativeFunctionCall.CallListIncrementOperation listVal.value.origins");var y,m=v(e.value.origins);try{for(m.s();!(y=m.n()).done;){var g=y.value;if(g.name==h.originName){p=g;break}}}catch(t){m.e(t)}finally{m.f()}if(null!=p){var k=p.TryGetItemWithValue(f,E.Null);k.exists&&r.Add(k.result,f)}}}catch(t){o.e(t)}finally{o.f()}return new j(r)}},{key:"CoerceValuesToSingleType",value:function(t){var n,i=S.Int,r=null,a=v(t);try{for(a.s();!(n=a.n()).done;){var o=u(n.value,A);o.valueType>i&&(i=o.valueType),o.valueType==S.List&&(r=e(o,j))}}catch(t){a.e(t)}finally{a.f()}var s=[];if(S[i]==S[S.List]){var l,h=v(t);try{for(h.s();!(l=h.n()).done;){var c=u(l.value,A);if(c.valueType==S.List)s.push(c);else{if(c.valueType!=S.Int)throw new P("Cannot mix Lists and "+S[c.valueType]+" values in this operation");var f=parseInt(c.valueObject);if(null===(r=u(r,j)).value)return d("NativeFunctionCall.CoerceValuesToSingleType specialCaseList.value");var p=r.value.originOfMaxItem;if(null===p)return d("NativeFunctionCall.CoerceValuesToSingleType list");var y=p.TryGetItemWithValue(f,E.Null);if(!y.exists)throw new P("Could not find List item with the value "+f+" in "+p.name);var m=new j(y.result,f);s.push(m)}}}catch(t){h.e(t)}finally{h.f()}}else{var g,k=v(t);try{for(k.s();!(g=k.n()).done;){var C=u(g.value,A).Cast(i);s.push(C)}}catch(t){k.e(t)}finally{k.f()}}return s}},{key:"AddOpFuncForType",value:function(t,e){null==this._operationFuncs&&(this._operationFuncs=new Map),this._operationFuncs.set(t,e)}},{key:"toString",value:function(){return'Native "'+this.name+'"'}}],[{key:"CallWithName",value:function(t){return new o(t)}},{key:"CallExistsWithName",value:function(t){return this.GenerateNativeFunctionsIfNecessary(),this._nativeFunctions.get(t)}},{key:"Identity",value:function(t){return t}},{key:"GenerateNativeFunctionsIfNecessary",value:function(){null==this._nativeFunctions&&(this._nativeFunctions=new Map,this.AddIntBinaryOp(this.Add,(function(t,e){return t+e})),this.AddIntBinaryOp(this.Subtract,(function(t,e){return t-e})),this.AddIntBinaryOp(this.Multiply,(function(t,e){return t*e})),this.AddIntBinaryOp(this.Divide,(function(t,e){return Math.floor(t/e)})),this.AddIntBinaryOp(this.Mod,(function(t,e){return t%e})),this.AddIntUnaryOp(this.Negate,(function(t){return-t})),this.AddIntBinaryOp(this.Equal,(function(t,e){return t==e})),this.AddIntBinaryOp(this.Greater,(function(t,e){return t>e})),this.AddIntBinaryOp(this.Less,(function(t,e){return t<e})),this.AddIntBinaryOp(this.GreaterThanOrEquals,(function(t,e){return t>=e})),this.AddIntBinaryOp(this.LessThanOrEquals,(function(t,e){return t<=e})),this.AddIntBinaryOp(this.NotEquals,(function(t,e){return t!=e})),this.AddIntUnaryOp(this.Not,(function(t){return 0==t})),this.AddIntBinaryOp(this.And,(function(t,e){return 0!=t&&0!=e})),this.AddIntBinaryOp(this.Or,(function(t,e){return 0!=t||0!=e})),this.AddIntBinaryOp(this.Max,(function(t,e){return Math.max(t,e)})),this.AddIntBinaryOp(this.Min,(function(t,e){return Math.min(t,e)})),this.AddIntBinaryOp(this.Pow,(function(t,e){return Math.pow(t,e)})),this.AddIntUnaryOp(this.Floor,o.Identity),this.AddIntUnaryOp(this.Ceiling,o.Identity),this.AddIntUnaryOp(this.Int,o.Identity),this.AddIntUnaryOp(this.Float,(function(t){return t})),this.AddFloatBinaryOp(this.Add,(function(t,e){return t+e})),this.AddFloatBinaryOp(this.Subtract,(function(t,e){return t-e})),this.AddFloatBinaryOp(this.Multiply,(function(t,e){return t*e})),this.AddFloatBinaryOp(this.Divide,(function(t,e){return t/e})),this.AddFloatBinaryOp(this.Mod,(function(t,e){return t%e})),this.AddFloatUnaryOp(this.Negate,(function(t){return-t})),this.AddFloatBinaryOp(this.Equal,(function(t,e){return t==e})),this.AddFloatBinaryOp(this.Greater,(function(t,e){return t>e})),this.AddFloatBinaryOp(this.Less,(function(t,e){return t<e})),this.AddFloatBinaryOp(this.GreaterThanOrEquals,(function(t,e){return t>=e})),this.AddFloatBinaryOp(this.LessThanOrEquals,(function(t,e){return t<=e})),this.AddFloatBinaryOp(this.NotEquals,(function(t,e){return t!=e})),this.AddFloatUnaryOp(this.Not,(function(t){return 0==t})),this.AddFloatBinaryOp(this.And,(function(t,e){return 0!=t&&0!=e})),this.AddFloatBinaryOp(this.Or,(function(t,e){return 0!=t||0!=e})),this.AddFloatBinaryOp(this.Max,(function(t,e){return Math.max(t,e)})),this.AddFloatBinaryOp(this.Min,(function(t,e){return Math.min(t,e)})),this.AddFloatBinaryOp(this.Pow,(function(t,e){return Math.pow(t,e)})),this.AddFloatUnaryOp(this.Floor,(function(t){return Math.floor(t)})),this.AddFloatUnaryOp(this.Ceiling,(function(t){return Math.ceil(t)})),this.AddFloatUnaryOp(this.Int,(function(t){return Math.floor(t)})),this.AddFloatUnaryOp(this.Float,o.Identity),this.AddStringBinaryOp(this.Add,(function(t,e){return t+e})),this.AddStringBinaryOp(this.Equal,(function(t,e){return t===e})),this.AddStringBinaryOp(this.NotEquals,(function(t,e){return!(t===e)})),this.AddStringBinaryOp(this.Has,(function(t,e){return t.includes(e)})),this.AddStringBinaryOp(this.Hasnt,(function(t,e){return!t.includes(e)})),this.AddListBinaryOp(this.Add,(function(t,e){return t.Union(e)})),this.AddListBinaryOp(this.Subtract,(function(t,e){return t.Without(e)})),this.AddListBinaryOp(this.Has,(function(t,e){return t.Contains(e)})),this.AddListBinaryOp(this.Hasnt,(function(t,e){return!t.Contains(e)})),this.AddListBinaryOp(this.Intersect,(function(t,e){return t.Intersect(e)})),this.AddListBinaryOp(this.Equal,(function(t,e){return t.Equals(e)})),this.AddListBinaryOp(this.Greater,(function(t,e){return t.GreaterThan(e)})),this.AddListBinaryOp(this.Less,(function(t,e){return t.LessThan(e)})),this.AddListBinaryOp(this.GreaterThanOrEquals,(function(t,e){return t.GreaterThanOrEquals(e)})),this.AddListBinaryOp(this.LessThanOrEquals,(function(t,e){return t.LessThanOrEquals(e)})),this.AddListBinaryOp(this.NotEquals,(function(t,e){return!t.Equals(e)})),this.AddListBinaryOp(this.And,(function(t,e){return t.Count>0&&e.Count>0})),this.AddListBinaryOp(this.Or,(function(t,e){return t.Count>0||e.Count>0})),this.AddListUnaryOp(this.Not,(function(t){return 0==t.Count?1:0})),this.AddListUnaryOp(this.Invert,(function(t){return t.inverse})),this.AddListUnaryOp(this.All,(function(t){return t.all})),this.AddListUnaryOp(this.ListMin,(function(t){return t.MinAsList()})),this.AddListUnaryOp(this.ListMax,(function(t){return t.MaxAsList()})),this.AddListUnaryOp(this.Count,(function(t){return t.Count})),this.AddListUnaryOp(this.ValueOfList,(function(t){return t.maxItem.Value})),this.AddOpToNativeFunc(this.Equal,2,S.DivertTarget,(function(t,e){return t.Equals(e)})),this.AddOpToNativeFunc(this.NotEquals,2,S.DivertTarget,(function(t,e){return!t.Equals(e)})))}},{key:"AddOpToNativeFunc",value:function(t,e,n,i){if(null===this._nativeFunctions)return d("NativeFunctionCall._nativeFunctions");var r=this._nativeFunctions.get(t);r||(r=new o(t,e),this._nativeFunctions.set(t,r)),r.AddOpFuncForType(n,i)}},{key:"AddIntBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,S.Int,e)}},{key:"AddIntUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,S.Int,e)}},{key:"AddFloatBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,S.Float,e)}},{key:"AddFloatUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,S.Float,e)}},{key:"AddStringBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,S.String,e)}},{key:"AddListBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,S.List,e)}},{key:"AddListUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,S.List,e)}}]),o}(_);H.Add="+",H.Subtract="-",H.Divide="/",H.Multiply="*",H.Mod="%",H.Negate="_",H.Equal="==",H.Greater=">",H.Less="<",H.GreaterThanOrEquals=">=",H.LessThanOrEquals="<=",H.NotEquals="!=",H.Not="!",H.And="&&",H.Or="||",H.Min="MIN",H.Max="MAX",H.Pow="POW",H.Floor="FLOOR",H.Ceiling="CEILING",H.Int="INT",H.Float="FLOAT",H.Has="?",H.Hasnt="!?",H.Intersect="^",H.ListMin="LIST_MIN",H.ListMax="LIST_MAX",H.All="LIST_ALL",H.Count="LIST_COUNT",H.ValueOfList="LIST_VALUE",H.Invert="LIST_INVERT",H._nativeFunctions=null;var X=function(t){function e(t){var e;return(e=n.call(this)).text=t.toString()||"",e}i(e,t);var n=r(e);return m(e,[{key:"toString",value:function(){return"# "+this.text}}]),e}(_),$=function(t){function e(){var t;return(t=n.apply(this,arguments)).text="",t.index=0,t.threadAtGeneration=null,t.sourcePath="",t.targetPath=null,t.isInvisibleDefault=!1,t.tags=null,t.originalThreadIndex=0,t}i(e,t);var n=r(e);return m(e,[{key:"pathStringOnChoice",get:function(){return null===this.targetPath?d("Choice.targetPath"):this.targetPath.toString()},set:function(t){this.targetPath=new b(t)}}]),e}(_),Y=function(){function t(t,e){this._name=t||"",this._items=null,this._itemNameToValues=e||new Map}return m(t,[{key:"name",get:function(){return this._name}},{key:"items",get:function(){if(null==this._items){this._items=new Map;var t,e=v(this._itemNameToValues);try{for(e.s();!(t=e.n()).done;){var i=n(t.value,2),r=i[1],a=new E(this.name,i[0]);this._items.set(a.serialized(),r)}}catch(t){e.e(t)}finally{e.f()}}return this._items}},{key:"ValueForItem",value:function(t){if(!t.itemName)return 0;var e=this._itemNameToValues.get(t.itemName);return void 0!==e?e:0}},{key:"ContainsItem",value:function(t){return!!t.itemName&&t.originName==this.name&&this._itemNameToValues.has(t.itemName)}},{key:"ContainsItemWithName",value:function(t){return this._itemNameToValues.has(t)}},{key:"TryGetItemWithValue",value:function(t){var e,i=v(this._itemNameToValues);try{for(i.s();!(e=i.n()).done;){var r=n(e.value,2);if(r[1]==t)return{result:new E(this.name,r[0]),exists:!0}}}catch(t){i.e(t)}finally{i.f()}return{result:E.Null,exists:!1}}},{key:"TryGetValueForItem",value:function(t){if(!t.itemName)return{result:0,exists:!1};var e=this._itemNameToValues.get(t.itemName);return e?{result:e,exists:!0}:{result:0,exists:!1}}}]),t}(),Q=function(){function t(t){this._lists=new Map,this._allUnambiguousListValueCache=new Map;var e,i=v(t);try{for(i.s();!(e=i.n()).done;){var r=e.value;this._lists.set(r.name,r);var a,o=v(r.items);try{for(o.s();!(a=o.n()).done;){var s=n(a.value,2),u=s[1],l=E.fromSerializedKey(s[0]),h=new j(l,u);if(!l.itemName)throw new Error("item.itemName is null or undefined.");this._allUnambiguousListValueCache.set(l.itemName,h),this._allUnambiguousListValueCache.set(l.fullName,h)}}catch(t){o.e(t)}finally{o.f()}}}catch(t){i.e(t)}finally{i.f()}}return m(t,[{key:"lists",get:function(){var t,e=[],i=v(this._lists);try{for(i.s();!(t=i.n()).done;){var r=n(t.value,2);e.push(r[1])}}catch(t){i.e(t)}finally{i.f()}return e}},{key:"TryListGetDefinition",value:function(t,e){if(null===t)return{result:e,exists:!1};var n=this._lists.get(t);return n?{result:n,exists:!0}:{result:e,exists:!1}}},{key:"FindSingleItemListWithName",value:function(t){if(null===t)return d("name");var e=this._allUnambiguousListValueCache.get(t);return void 0!==e?e:null}}]),t}(),Z=function(){function t(){}return m(t,null,[{key:"JArrayToRuntimeObjList",value:function(t){var e=t.length;arguments.length>1&&void 0!==arguments[1]&&arguments[1]&&e--;for(var n=[],i=0;i<e;i++){var r=this.JTokenToRuntimeObject(t[i]);if(null===r)return d("runtimeObj");n.push(r)}return n}},{key:"WriteDictionaryRuntimeObjs",value:function(t,e){t.WriteObjectStart();var i,r=v(e);try{for(r.s();!(i=r.n()).done;){var a=n(i.value,2),o=a[1];t.WritePropertyStart(a[0]),this.WriteRuntimeObject(t,o),t.WritePropertyEnd()}}catch(t){r.e(t)}finally{r.f()}t.WriteObjectEnd()}},{key:"WriteListRuntimeObjs",value:function(t,e){t.WriteArrayStart();var n,i=v(e);try{for(i.s();!(n=i.n()).done;)this.WriteRuntimeObject(t,n.value)}catch(t){i.e(t)}finally{i.f()}t.WriteArrayEnd()}},{key:"WriteIntDictionary",value:function(t,e){t.WriteObjectStart();var i,r=v(e);try{for(r.s();!(i=r.n()).done;){var a=n(i.value,2);t.WriteIntProperty(a[0],a[1])}}catch(t){r.e(t)}finally{r.f()}t.WriteObjectEnd()}},{key:"WriteRuntimeObject",value:function(n,i){var r=e(i,D);if(r)this.WriteRuntimeContainer(n,r);else{var a=e(i,J);if(a){var o,s="->";return a.isExternal?s="x()":a.pushesToStack&&(a.stackPushType==k.Function?s="f()":a.stackPushType==k.Tunnel&&(s="->t->")),o=a.hasVariableTarget?a.variableDivertName:a.targetPathString,n.WriteObjectStart(),n.WriteProperty(s,o),a.hasVariableTarget&&n.WriteProperty("var",!0),a.isConditional&&n.WriteProperty("c",!0),a.externalArgs>0&&n.WriteIntProperty("exArgs",a.externalArgs),void n.WriteObjectEnd()}var u=e(i,U);if(u)return n.WriteObjectStart(),n.WriteProperty("*",u.pathStringOnChoice),n.WriteIntProperty("flg",u.flags),void n.WriteObjectEnd();var l=e(i,I);if(l)n.WriteBool(l.value);else{var h=e(i,F);if(h)n.WriteInt(h.value);else{var c=e(i,x);if(c)n.WriteFloat(c.value);else{var f=e(i,W);if(f)f.isNewline?n.Write("\n",!1):(n.WriteStringStart(),n.WriteStringInner("^"),n.WriteStringInner(f.value),n.WriteStringEnd());else{var v=e(i,j);if(v)this.WriteInkList(n,v);else{var p=e(i,V);if(p)return n.WriteObjectStart(),null===p.value?d("divTargetVal.value"):(n.WriteProperty("^->",p.value.componentsString),void n.WriteObjectEnd());var y=e(i,L);if(y)return n.WriteObjectStart(),n.WriteProperty("^var",y.value),n.WriteIntProperty("ci",y.contextIndex),void n.WriteObjectEnd();if(e(i,B))n.Write("<>");else{var m=e(i,G);if(m)n.Write(t._controlCommandNames[m.commandType]);else{var g=e(i,H);if(g){var S=g.name;return"^"==S&&(S="L^"),void n.Write(S)}var C=e(i,q);if(C){n.WriteObjectStart();var b=C.pathStringForCount;return null!=b?n.WriteProperty("CNT?",b):n.WriteProperty("VAR?",C.name),void n.WriteObjectEnd()}var w=e(i,K);if(w)return n.WriteObjectStart(),n.WriteProperty(w.isGlobal?"VAR=":"temp=",w.variableName),w.isNewDeclaration||n.WriteProperty("re",!0),void n.WriteObjectEnd();if(e(i,z))n.Write("void");else{var _=e(i,X);if(_)return n.WriteObjectStart(),n.WriteProperty("#",_.text),void n.WriteObjectEnd();var T=e(i,$);if(!T)throw new Error("Failed to convert runtime object to Json token: "+i);this.WriteChoice(n,T)}}}}}}}}}}},{key:"JObjectToDictionaryRuntimeObjs",value:function(t){var e=new Map;for(var n in t)if(t.hasOwnProperty(n)){var i=this.JTokenToRuntimeObject(t[n]);if(null===i)return d("inkObject");e.set(n,i)}return e}},{key:"JObjectToIntDictionary",value:function(t){var e=new Map;for(var n in t)t.hasOwnProperty(n)&&e.set(n,parseInt(t[n]));return e}},{key:"JTokenToRuntimeObject",value:function(e){if("number"==typeof e&&!isNaN(e)||"boolean"==typeof e)return A.Create(e);if("string"==typeof e){var n=e.toString(),i=n[0];if("^"==i)return new W(n.substring(1));if("\n"==i&&1==n.length)return new W("\n");if("<>"==n)return new B;for(var r=0;r<t._controlCommandNames.length;++r)if(n==t._controlCommandNames[r])return new G(r);if("L^"==n&&(n="^"),H.CallExistsWithName(n))return H.CallWithName(n);if("->->"==n)return G.PopTunnel();if("~ret"==n)return G.PopFunction();if("void"==n)return new z}if("object"==g(e)&&!Array.isArray(e)){var a,o=e;if(o["^->"])return new V(new b((a=o["^->"]).toString()));if(o["^var"]){var s=new L((a=o["^var"]).toString());return"ci"in o&&(a=o.ci,s.contextIndex=parseInt(a)),s}var u=!1,l=!1,h=k.Function,c=!1;if((a=o["->"])?u=!0:(a=o["f()"])?(u=!0,l=!0,h=k.Function):(a=o["->t->"])?(u=!0,l=!0,h=k.Tunnel):(a=o["x()"])&&(u=!0,c=!0,l=!1,h=k.Function),u){var f=new J;f.pushesToStack=l,f.stackPushType=h,f.isExternal=c;var v=a.toString();return(a=o.var)?f.variableDivertName=v:f.targetPathString=v,f.isConditional=!!o.c,c&&(a=o.exArgs)&&(f.externalArgs=parseInt(a)),f}if(a=o["*"]){var d=new U;return d.pathStringOnChoice=a.toString(),(a=o.flg)&&(d.flags=parseInt(a)),d}if(a=o["VAR?"])return new q(a.toString());if(a=o["CNT?"]){var p=new q;return p.pathStringForCount=a.toString(),p}var y=!1,m=!1;if((a=o["VAR="])?(y=!0,m=!0):(a=o["temp="])&&(y=!0,m=!1),y){var S=a.toString(),C=new K(S,!o.re);return C.isGlobal=m,C}if(void 0!==o["#"])return new X((a=o["#"]).toString());if(a=o.list){var w=a,_=new O;for(var T in(a=o.origins)&&_.SetInitialOriginNames(a),w)if(w.hasOwnProperty(T)){var P=w[T],N=new E(T),I=parseInt(P);_.Add(N,I)}return new j(_)}if(null!=o.originalChoicePath)return this.JObjectToChoice(o)}if(Array.isArray(e))return this.JArrayToContainer(e);if(null==e)return null;throw new Error("Failed to convert token to runtime object: "+this.toJson(e,["parent"]))}},{key:"toJson",value:function(t,e,n){return JSON.stringify(t,(function(t,n){return(null==e?void 0:e.some((function(e){return e===t})))?void 0:n}),n)}},{key:"WriteRuntimeContainer",value:function(t,i){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(t.WriteArrayStart(),null===i)return d("container");var a,o=v(i.content);try{for(o.s();!(a=o.n()).done;)this.WriteRuntimeObject(t,a.value)}catch(t){o.e(t)}finally{o.f()}var s=i.namedOnlyContent,u=i.countFlags,l=null!=i.name&&!r,h=null!=s||u>0||l;if(h&&t.WriteObjectStart(),null!=s){var c,f=v(s);try{for(f.s();!(c=f.n()).done;){var p=n(c.value,2),y=p[0],m=e(p[1],D);t.WritePropertyStart(y),this.WriteRuntimeContainer(t,m,!0),t.WritePropertyEnd()}}catch(t){f.e(t)}finally{f.f()}}u>0&&t.WriteIntProperty("#f",u),l&&t.WriteProperty("#n",i.name),h?t.WriteObjectEnd():t.WriteNull(),t.WriteArrayEnd()}},{key:"JArrayToContainer",value:function(t){var n=new D;n.content=this.JArrayToRuntimeObjList(t,!0);var i=t[t.length-1];if(null!=i){var r=new Map;for(var a in i)if("#f"==a)n.countFlags=parseInt(i[a]);else if("#n"==a)n.name=i[a].toString();else{var o=this.JTokenToRuntimeObject(i[a]),s=e(o,D);s&&(s.name=a),r.set(a,o)}n.namedOnlyContent=r}return n}},{key:"JObjectToChoice",value:function(t){var e=new $;return e.text=t.text.toString(),e.index=parseInt(t.index),e.sourcePath=t.originalChoicePath.toString(),e.originalThreadIndex=parseInt(t.originalThreadIndex),e.pathStringOnChoice=t.targetPath.toString(),t.tags&&(e.tags=t.tags),e}},{key:"WriteChoice",value:function(t,e){t.WriteObjectStart(),t.WriteProperty("text",e.text),t.WriteIntProperty("index",e.index),t.WriteProperty("originalChoicePath",e.sourcePath),t.WriteIntProperty("originalThreadIndex",e.originalThreadIndex),t.WriteProperty("targetPath",e.pathStringOnChoice),e.tags&&t.WriteProperty("tags",(function(t){t.WriteArrayStart();var n,i=v(e.tags);try{for(i.s();!(n=i.n()).done;){var r=n.value;t.WriteStringStart(),t.WriteStringInner(r),t.WriteStringEnd()}}catch(t){i.e(t)}finally{i.f()}t.WriteArrayEnd()})),t.WriteObjectEnd()}},{key:"WriteInkList",value:function(t,e){var i=e.value;if(null===i)return d("rawList");t.WriteObjectStart(),t.WritePropertyStart("list"),t.WriteObjectStart();var r,a=v(i);try{for(a.s();!(r=a.n()).done;){var o=n(r.value,2),s=o[1],u=E.fromSerializedKey(o[0]),l=s;if(null===u.itemName)return d("item.itemName");t.WritePropertyNameStart(),t.WritePropertyNameInner(u.originName?u.originName:"?"),t.WritePropertyNameInner("."),t.WritePropertyNameInner(u.itemName),t.WritePropertyNameEnd(),t.Write(l),t.WritePropertyEnd()}}catch(t){a.e(t)}finally{a.f()}if(t.WriteObjectEnd(),t.WritePropertyEnd(),0==i.Count&&null!=i.originNames&&i.originNames.length>0){t.WritePropertyStart("origins"),t.WriteArrayStart();var h,c=v(i.originNames);try{for(c.s();!(h=c.n()).done;)t.Write(h.value)}catch(t){c.e(t)}finally{c.f()}t.WriteArrayEnd(),t.WritePropertyEnd()}t.WriteObjectEnd()}},{key:"ListDefinitionsToJToken",value:function(t){var e,i={},r=v(t.lists);try{for(r.s();!(e=r.n()).done;){var a,o=e.value,s={},u=v(o.items);try{for(u.s();!(a=u.n()).done;){var l=n(a.value,2),h=l[1],c=E.fromSerializedKey(l[0]);if(null===c.itemName)return d("item.itemName");s[c.itemName]=h}}catch(t){u.e(t)}finally{u.f()}i[o.name]=s}}catch(t){r.e(t)}finally{r.f()}return i}},{key:"JTokenToListDefinitions",value:function(t){var e=t,n=[];for(var i in e)if(e.hasOwnProperty(i)){var r=i.toString(),a=e[i],o=new Map;for(var s in a)e.hasOwnProperty(i)&&o.set(s,parseInt(a[s]));var u=new Y(r,o);n.push(u)}return new Q(n)}}]),t}();Z._controlCommandNames=function(){var t=[];t[G.CommandType.EvalStart]="ev",t[G.CommandType.EvalOutput]="out",t[G.CommandType.EvalEnd]="/ev",t[G.CommandType.Duplicate]="du",t[G.CommandType.PopEvaluatedValue]="pop",t[G.CommandType.PopFunction]="~ret",t[G.CommandType.PopTunnel]="->->",t[G.CommandType.BeginString]="str",t[G.CommandType.EndString]="/str",t[G.CommandType.NoOp]="nop",t[G.CommandType.ChoiceCount]="choiceCnt",t[G.CommandType.Turns]="turn",t[G.CommandType.TurnsSince]="turns",t[G.CommandType.ReadCount]="readc",t[G.CommandType.Random]="rnd",t[G.CommandType.SeedRandom]="srnd",t[G.CommandType.VisitIndex]="visit",t[G.CommandType.SequenceShuffleIndex]="seq",t[G.CommandType.StartThread]="thread",t[G.CommandType.Done]="done",t[G.CommandType.End]="end",t[G.CommandType.ListFromInt]="listInt",t[G.CommandType.ListRange]="range",t[G.CommandType.ListRandom]="lrnd",t[G.CommandType.BeginTag]="#",t[G.CommandType.EndTag]="/#";for(var e=0;e<G.CommandType.TOTAL_VALUES;++e)if(null==t[e])throw new Error("Control command not accounted for in serialisation");return t}();var tt=function(){function t(){if(this._threadCounter=0,this._startOfRoot=M.Null,arguments[0]instanceof ut)this._startOfRoot=M.StartOf(arguments[0].rootContentContainer),this.Reset();else{var t=arguments[0];this._threads=[];var e,n=v(t._threads);try{for(n.s();!(e=n.n()).done;)this._threads.push(e.value.Copy())}catch(t){n.e(t)}finally{n.f()}this._threadCounter=t._threadCounter,this._startOfRoot=t._startOfRoot.copy()}}return m(t,[{key:"elements",get:function(){return this.callStack}},{key:"depth",get:function(){return this.elements.length}},{key:"currentElement",get:function(){var t=this._threads[this._threads.length-1].callstack;return t[t.length-1]}},{key:"currentElementIndex",get:function(){return this.callStack.length-1}},{key:"currentThread",get:function(){return this._threads[this._threads.length-1]},set:function(t){y.Assert(1==this._threads.length,"Shouldn't be directly setting the current thread when we have a stack of them"),this._threads.length=0,this._threads.push(t)}},{key:"canPop",get:function(){return this.callStack.length>1}},{key:"Reset",value:function(){this._threads=[],this._threads.push(new t.Thread),this._threads[0].callstack.push(new t.Element(k.Tunnel,this._startOfRoot))}},{key:"SetJsonToken",value:function(e,n){this._threads.length=0;var i,r=v(e.threads);try{for(r.s();!(i=r.n()).done;){var a=new t.Thread(i.value,n);this._threads.push(a)}}catch(t){r.e(t)}finally{r.f()}this._threadCounter=parseInt(e.threadCounter),this._startOfRoot=M.StartOf(n.rootContentContainer)}},{key:"WriteJson",value:function(t){var e=this;t.WriteObject((function(t){t.WritePropertyStart("threads"),t.WriteArrayStart();var n,i=v(e._threads);try{for(i.s();!(n=i.n()).done;)n.value.WriteJson(t)}catch(t){i.e(t)}finally{i.f()}t.WriteArrayEnd(),t.WritePropertyEnd(),t.WritePropertyStart("threadCounter"),t.WriteInt(e._threadCounter),t.WritePropertyEnd()}))}},{key:"PushThread",value:function(){var t=this.currentThread.Copy();this._threadCounter++,t.threadIndex=this._threadCounter,this._threads.push(t)}},{key:"ForkThread",value:function(){var t=this.currentThread.Copy();return this._threadCounter++,t.threadIndex=this._threadCounter,t}},{key:"PopThread",value:function(){if(!this.canPopThread)throw new Error("Can't pop thread");this._threads.splice(this._threads.indexOf(this.currentThread),1)}},{key:"canPopThread",get:function(){return this._threads.length>1&&!this.elementIsEvaluateFromGame}},{key:"elementIsEvaluateFromGame",get:function(){return this.currentElement.type==k.FunctionEvaluationFromGame}},{key:"Push",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=new t.Element(e,this.currentElement.currentPointer,!1);r.evaluationStackHeightWhenPushed=n,r.functionStartInOutputStream=i,this.callStack.push(r)}},{key:"CanPop",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return!!this.canPop&&(null==t||this.currentElement.type==t)}},{key:"Pop",value:function(){if(!this.CanPop(arguments.length>0&&void 0!==arguments[0]?arguments[0]:null))throw new Error("Mismatched push/pop in Callstack");this.callStack.pop()}},{key:"GetTemporaryVariableWithName",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;-1==e&&(e=this.currentElementIndex+1);var n=p(this.callStack[e-1].temporaryVariables,t,null);return n.exists?n.result:null}},{key:"SetTemporaryVariable",value:function(t,e,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1;-1==i&&(i=this.currentElementIndex+1);var r=this.callStack[i-1];if(!n&&!r.temporaryVariables.get(t))throw new Error("Could not find temporary variable to set: "+t);var a=p(r.temporaryVariables,t,null);a.exists&&j.RetainListOriginsForAssignment(a.result,e),r.temporaryVariables.set(t,e)}},{key:"ContextForVariableNamed",value:function(t){return this.currentElement.temporaryVariables.get(t)?this.currentElementIndex+1:0}},{key:"ThreadWithIndex",value:function(t){var e=this._threads.filter((function(e){if(e.threadIndex==t)return e}));return e.length>0?e[0]:null}},{key:"callStack",get:function(){return this.currentThread.callstack}},{key:"callStackTrace",get:function(){for(var t=new T,e=0;e<this._threads.length;e++){var n=this._threads[e];t.AppendFormat("=== THREAD {0}/{1} {2}===\n",e+1,this._threads.length,e==this._threads.length-1?"(current) ":"");for(var i=0;i<n.callstack.length;i++){t.Append(n.callstack[i].type==k.Function?"  [FUNCTION] ":"  [TUNNEL] ");var r=n.callstack[i].currentPointer;if(!r.isNull){if(t.Append("<SOMEWHERE IN "),null===r.container)return d("pointer.container");t.Append(r.container.path.toString()),t.AppendLine(">")}}}return t.toString()}}]),t}();!function(t){var e=function(){function t(t,e){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.evaluationStackHeightWhenPushed=0,this.functionStartInOutputStream=0,this.currentPointer=e.copy(),this.inExpressionEvaluation=n,this.temporaryVariables=new Map,this.type=t}return m(t,[{key:"Copy",value:function(){var e=new t(this.type,this.currentPointer,this.inExpressionEvaluation);return e.temporaryVariables=new Map(this.temporaryVariables),e.evaluationStackHeightWhenPushed=this.evaluationStackHeightWhenPushed,e.functionStartInOutputStream=this.functionStartInOutputStream,e}}]),t}();t.Element=e;var n=function(){function t(){if(this.threadIndex=0,this.previousPointer=M.Null,this.callstack=[],arguments[0]&&arguments[1]){var t=arguments[0],n=arguments[1];this.threadIndex=parseInt(t.threadIndex);var i,r=v(t.callstack);try{for(r.s();!(i=r.n()).done;){var a=void 0,o=i.value,s=parseInt(o.type),u=M.Null,l=o.cPath;if(void 0!==l){a=l.toString();var h=n.ContentAtPath(new b(a));if(u.container=h.container,u.index=parseInt(o.idx),null==h.obj)throw new Error("When loading state, internal story location couldn't be found: "+a+". Has the story changed since this save data was created?");if(h.approximate){if(null===u.container)return d("pointer.container");n.Warning("When loading state, exact internal story location couldn't be found: '"+a+"', so it was approximated to '"+u.container.path.toString()+"' to recover. Has the story changed since this save data was created?")}}var c=new e(s,u,!!o.exp),f=o.temp;void 0!==f?c.temporaryVariables=Z.JObjectToDictionaryRuntimeObjs(f):c.temporaryVariables.clear(),this.callstack.push(c)}}catch(t){r.e(t)}finally{r.f()}var p=t.previousContentObject;if(void 0!==p){var y=new b(p.toString());this.previousPointer=n.PointerAtPath(y)}}}return m(t,[{key:"Copy",value:function(){var e=new t;e.threadIndex=this.threadIndex;var n,i=v(this.callstack);try{for(i.s();!(n=i.n()).done;)e.callstack.push(n.value.Copy())}catch(t){i.e(t)}finally{i.f()}return e.previousPointer=this.previousPointer.copy(),e}},{key:"WriteJson",value:function(t){t.WriteObjectStart(),t.WritePropertyStart("callstack"),t.WriteArrayStart();var e,n=v(this.callstack);try{for(n.s();!(e=n.n()).done;){var i=e.value;if(t.WriteObjectStart(),!i.currentPointer.isNull){if(null===i.currentPointer.container)return d("el.currentPointer.container");t.WriteProperty("cPath",i.currentPointer.container.path.componentsString),t.WriteIntProperty("idx",i.currentPointer.index)}t.WriteProperty("exp",i.inExpressionEvaluation),t.WriteIntProperty("type",i.type),i.temporaryVariables.size>0&&(t.WritePropertyStart("temp"),Z.WriteDictionaryRuntimeObjs(t,i.temporaryVariables),t.WritePropertyEnd()),t.WriteObjectEnd()}}catch(t){n.e(t)}finally{n.f()}if(t.WriteArrayEnd(),t.WritePropertyEnd(),t.WriteIntProperty("threadIndex",this.threadIndex),!this.previousPointer.isNull){var r=this.previousPointer.Resolve();if(null===r)return d("this.previousPointer.Resolve()");t.WriteProperty("previousContentObject",r.path.toString())}t.WriteObjectEnd()}}]),t}();t.Thread=n}(tt||(tt={}));var et=function(t){function s(t,e){var n;(n=l.call(this)).variableChangedEventCallbacks=[],n.patch=null,n._batchObservingVariableChanges=!1,n._defaultGlobalVariables=new Map,n._changedVariablesForBatchObs=new Set,n._globalVariables=new Map,n._callStack=t,n._listDefsOrigin=e;try{return a(n,new Proxy(o(n),{get:function(t,e){return e in t?t[e]:t.$(e)},set:function(t,e,n){return e in t?t[e]=n:t.$(e,n),!0}}))}catch(t){}return n}i(s,t);var l=r(s);return m(s,[{key:"variableChangedEvent",value:function(t,e){var n,i=v(this.variableChangedEventCallbacks);try{for(i.s();!(n=i.n()).done;)(0,n.value)(t,e)}catch(t){i.e(t)}finally{i.f()}}},{key:"batchObservingVariableChanges",get:function(){return this._batchObservingVariableChanges},set:function(t){if(this._batchObservingVariableChanges=t,t)this._changedVariablesForBatchObs=new Set;else if(null!=this._changedVariablesForBatchObs){var e,n=v(this._changedVariablesForBatchObs);try{for(n.s();!(e=n.n()).done;){var i=e.value,r=this._globalVariables.get(i);r?this.variableChangedEvent(i,r):d("currentValue")}}catch(t){n.e(t)}finally{n.f()}this._changedVariablesForBatchObs=null}}},{key:"callStack",get:function(){return this._callStack},set:function(t){this._callStack=t}},{key:"$",value:function(t,e){if(void 0===e){var n=null;return null!==this.patch&&(n=this.patch.TryGetGlobal(t,null)).exists?n.result.valueObject:(void 0===(n=this._globalVariables.get(t))&&(n=this._defaultGlobalVariables.get(t)),void 0!==n?n.valueObject:null)}if(void 0===this._defaultGlobalVariables.get(t))throw new P("Cannot assign to a variable ("+t+") that hasn't been declared in the story");var i=A.Create(e);if(null==i)throw null==e?new Error("Cannot pass null to VariableState"):new Error("Invalid value passed to VariableState: "+e.toString());this.SetGlobal(t,i)}},{key:"ApplyPatch",value:function(){if(null===this.patch)return d("this.patch");var t,e=v(this.patch.globals);try{for(e.s();!(t=e.n()).done;){var i=n(t.value,2);this._globalVariables.set(i[0],i[1])}}catch(t){e.e(t)}finally{e.f()}if(null!==this._changedVariablesForBatchObs){var r,a=v(this.patch.changedVariables);try{for(a.s();!(r=a.n()).done;)this._changedVariablesForBatchObs.add(r.value)}catch(t){a.e(t)}finally{a.f()}}this.patch=null}},{key:"SetJsonToken",value:function(t){this._globalVariables.clear();var e,i=v(this._defaultGlobalVariables);try{for(i.s();!(e=i.n()).done;){var r=n(e.value,2),a=r[0],o=r[1],s=t[a];if(void 0!==s){var u=Z.JTokenToRuntimeObject(s);if(null===u)return d("tokenInkObject");this._globalVariables.set(a,u)}else this._globalVariables.set(a,o)}}catch(t){i.e(t)}finally{i.f()}}},{key:"WriteJson",value:function(t){t.WriteObjectStart();var e,i=v(this._globalVariables);try{for(i.s();!(e=i.n()).done;){var r=n(e.value,2),a=r[0],o=r[1];if(s.dontSaveDefaultValues&&this._defaultGlobalVariables.has(a)){var u=this._defaultGlobalVariables.get(a);if(this.RuntimeObjectsEqual(o,u))continue}t.WritePropertyStart(a),Z.WriteRuntimeObject(t,o),t.WritePropertyEnd()}}catch(t){i.e(t)}finally{i.f()}t.WriteObjectEnd()}},{key:"RuntimeObjectsEqual",value:function(t,n){if(null===t)return d("obj1");if(null===n)return d("obj2");if(t.constructor!==n.constructor)return!1;var i=e(t,I);if(null!==i)return i.value===u(n,I).value;var r=e(t,F);if(null!==r)return r.value===u(n,F).value;var a=e(t,x);if(null!==a)return a.value===u(n,x).value;var o=e(t,A),s=e(n,A);if(null!==o&&null!==s)return c(o.valueObject)&&c(s.valueObject)?o.valueObject.Equals(s.valueObject):o.valueObject===s.valueObject;throw new Error("FastRoughDefinitelyEquals: Unsupported runtime object type: "+t.constructor.name)}},{key:"GetVariableWithName",value:function(t){var n=this.GetRawVariableWithName(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1),i=e(n,L);return null!==i&&(n=this.ValueAtVariablePointer(i)),n}},{key:"TryGetDefaultVariableValue",value:function(t){var e=p(this._defaultGlobalVariables,t,null);return e.exists?e.result:null}},{key:"GlobalVariableExistsWithName",value:function(t){return this._globalVariables.has(t)||null!==this._defaultGlobalVariables&&this._defaultGlobalVariables.has(t)}},{key:"GetRawVariableWithName",value:function(t,e){if(0==e||-1==e){var n=null;if(null!==this.patch&&(n=this.patch.TryGetGlobal(t,null)).exists)return n.result;if((n=p(this._globalVariables,t,null)).exists)return n.result;if(null!==this._defaultGlobalVariables&&(n=p(this._defaultGlobalVariables,t,null)).exists)return n.result;if(null===this._listDefsOrigin)return d("VariablesState._listDefsOrigin");var i=this._listDefsOrigin.FindSingleItemListWithName(t);if(i)return i}return this._callStack.GetTemporaryVariableWithName(t,e)}},{key:"ValueAtVariablePointer",value:function(t){return this.GetVariableWithName(t.variableName,t.contextIndex)}},{key:"Assign",value:function(t,n){var i=t.variableName;if(null===i)return d("name");var r=-1,a=!1;if(a=t.isNewDeclaration?t.isGlobal:this.GlobalVariableExistsWithName(i),t.isNewDeclaration){var o=e(n,L);null!==o&&(n=this.ResolveVariablePointer(o))}else{var s=null;do{null!=(s=e(this.GetRawVariableWithName(i,r),L))&&(i=s.variableName,a=0==(r=s.contextIndex))}while(null!=s)}a?this.SetGlobal(i,n):this._callStack.SetTemporaryVariable(i,n,t.isNewDeclaration,r)}},{key:"SnapshotDefaultGlobals",value:function(){this._defaultGlobalVariables=new Map(this._globalVariables)}},{key:"RetainListOriginsForAssignment",value:function(t,e){var n=u(t,j),i=u(e,j);n.value&&i.value&&0==i.value.Count&&i.value.SetInitialOriginNames(n.value.originNames)}},{key:"SetGlobal",value:function(t,e){var n=null;if(null===this.patch&&(n=p(this._globalVariables,t,null)),null!==this.patch&&((n=this.patch.TryGetGlobal(t,null)).exists||(n=p(this._globalVariables,t,null))),j.RetainListOriginsForAssignment(n.result,e),null===t)return d("variableName");if(null!==this.patch?this.patch.SetGlobal(t,e):this._globalVariables.set(t,e),null!==this.variableChangedEvent&&null!==n&&e!==n.result)if(this.batchObservingVariableChanges){if(null===this._changedVariablesForBatchObs)return d("this._changedVariablesForBatchObs");null!==this.patch?this.patch.AddChangedVariable(t):null!==this._changedVariablesForBatchObs&&this._changedVariablesForBatchObs.add(t)}else this.variableChangedEvent(t,e)}},{key:"ResolveVariablePointer",value:function(t){var n=t.contextIndex;-1==n&&(n=this.GetContextIndexOfVariableNamed(t.variableName));var i=e(this.GetRawVariableWithName(t.variableName,n),L);return null!=i?i:new L(t.variableName,n)}},{key:"GetContextIndexOfVariableNamed",value:function(t){return this.GlobalVariableExistsWithName(t)?0:this._callStack.currentElementIndex}},{key:"ObserveVariableChange",value:function(t){this.variableChangedEventCallbacks.push(t)}}]),s}(function(){return m((function(){}))}());et.dontSaveDefaultValues=!0;var nt=function(){function t(t){this.seed=t%2147483647,this.seed<=0&&(this.seed+=2147483646)}return m(t,[{key:"next",value:function(){return this.seed=48271*this.seed%2147483647}},{key:"nextFloat",value:function(){return(this.next()-1)/2147483646}}]),t}(),it=function(){function t(){if(this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map,1===arguments.length&&null!==arguments[0]){var t=arguments[0];this._globals=new Map(t._globals),this._changedVariables=new Set(t._changedVariables),this._visitCounts=new Map(t._visitCounts),this._turnIndices=new Map(t._turnIndices)}else this._globals=new Map,this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map}return m(t,[{key:"globals",get:function(){return this._globals}},{key:"changedVariables",get:function(){return this._changedVariables}},{key:"visitCounts",get:function(){return this._visitCounts}},{key:"turnIndices",get:function(){return this._turnIndices}},{key:"TryGetGlobal",value:function(t,e){return null!==t&&this._globals.has(t)?{result:this._globals.get(t),exists:!0}:{result:e,exists:!1}}},{key:"SetGlobal",value:function(t,e){this._globals.set(t,e)}},{key:"AddChangedVariable",value:function(t){return this._changedVariables.add(t)}},{key:"TryGetVisitCount",value:function(t,e){return this._visitCounts.has(t)?{result:this._visitCounts.get(t),exists:!0}:{result:e,exists:!1}}},{key:"SetVisitCount",value:function(t,e){this._visitCounts.set(t,e)}},{key:"SetTurnIndex",value:function(t,e){this._turnIndices.set(t,e)}},{key:"TryGetTurnIndex",value:function(t,e){return this._turnIndices.has(t)?{result:this._turnIndices.get(t),exists:!0}:{result:e,exists:!1}}}]),t}(),rt=function(){function t(){}return m(t,null,[{key:"TextToDictionary",value:function(e){return new t.Reader(e).ToDictionary()}},{key:"TextToArray",value:function(e){return new t.Reader(e).ToArray()}}]),t}();!function(t){t.Reader=function(){function t(t){this._rootObject=JSON.parse(t)}return m(t,[{key:"ToDictionary",value:function(){return this._rootObject}},{key:"ToArray",value:function(){return this._rootObject}}]),t}();var e=function(){function e(){this._currentPropertyName=null,this._currentString=null,this._stateStack=[],this._collectionStack=[],this._propertyNameStack=[],this._jsonObject=null}return m(e,[{key:"WriteObject",value:function(t){this.WriteObjectStart(),t(this),this.WriteObjectEnd()}},{key:"WriteObjectStart",value:function(){this.StartNewObject(!0);var e={};if(this.state===t.Writer.State.Property){this.Assert(null!==this.currentCollection),this.Assert(null!==this.currentPropertyName);var n=this._propertyNameStack.pop();this.currentCollection[n]=e,this._collectionStack.push(e)}else this.state===t.Writer.State.Array?(this.Assert(null!==this.currentCollection),this.currentCollection.push(e),this._collectionStack.push(e)):(this.Assert(this.state===t.Writer.State.None),this._jsonObject=e,this._collectionStack.push(e));this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Object))}},{key:"WriteObjectEnd",value:function(){this.Assert(this.state===t.Writer.State.Object),this._collectionStack.pop(),this._stateStack.pop()}},{key:"WriteProperty",value:function(t,e){this.WritePropertyStart(t),arguments[1]instanceof Function?(0,arguments[1])(this):this.Write(arguments[1]),this.WritePropertyEnd()}},{key:"WriteIntProperty",value:function(t,e){this.WritePropertyStart(t),this.WriteInt(e),this.WritePropertyEnd()}},{key:"WriteFloatProperty",value:function(t,e){this.WritePropertyStart(t),this.WriteFloat(e),this.WritePropertyEnd()}},{key:"WritePropertyStart",value:function(e){this.Assert(this.state===t.Writer.State.Object),this._propertyNameStack.push(e),this.IncrementChildCount(),this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Property))}},{key:"WritePropertyEnd",value:function(){this.Assert(this.state===t.Writer.State.Property),this.Assert(1===this.childCount),this._stateStack.pop()}},{key:"WritePropertyNameStart",value:function(){this.Assert(this.state===t.Writer.State.Object),this.IncrementChildCount(),this._currentPropertyName="",this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Property)),this._stateStack.push(new t.Writer.StateElement(t.Writer.State.PropertyName))}},{key:"WritePropertyNameEnd",value:function(){this.Assert(this.state===t.Writer.State.PropertyName),this.Assert(null!==this._currentPropertyName),this._propertyNameStack.push(this._currentPropertyName),this._currentPropertyName=null,this._stateStack.pop()}},{key:"WritePropertyNameInner",value:function(e){this.Assert(this.state===t.Writer.State.PropertyName),this.Assert(null!==this._currentPropertyName),this._currentPropertyName+=e}},{key:"WriteArrayStart",value:function(){this.StartNewObject(!0);var e=[];if(this.state===t.Writer.State.Property){this.Assert(null!==this.currentCollection),this.Assert(null!==this.currentPropertyName);var n=this._propertyNameStack.pop();this.currentCollection[n]=e,this._collectionStack.push(e)}else this.state===t.Writer.State.Array?(this.Assert(null!==this.currentCollection),this.currentCollection.push(e),this._collectionStack.push(e)):(this.Assert(this.state===t.Writer.State.None),this._jsonObject=e,this._collectionStack.push(e));this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Array))}},{key:"WriteArrayEnd",value:function(){this.Assert(this.state===t.Writer.State.Array),this._collectionStack.pop(),this._stateStack.pop()}},{key:"Write",value:function(t){null!==t?(this.StartNewObject(!1),this._addToCurrentObject(t)):console.error("Warning: trying to write a null value")}},{key:"WriteBool",value:function(t){null!==t&&(this.StartNewObject(!1),this._addToCurrentObject(t))}},{key:"WriteInt",value:function(t){null!==t&&(this.StartNewObject(!1),this._addToCurrentObject(Math.floor(t)))}},{key:"WriteFloat",value:function(t){null!==t&&(this.StartNewObject(!1),t==Number.POSITIVE_INFINITY?this._addToCurrentObject(34e37):t==Number.NEGATIVE_INFINITY?this._addToCurrentObject(-34e37):isNaN(t)?this._addToCurrentObject(0):this._addToCurrentObject(t))}},{key:"WriteNull",value:function(){this.StartNewObject(!1),this._addToCurrentObject(null)}},{key:"WriteStringStart",value:function(){this.StartNewObject(!1),this._currentString="",this._stateStack.push(new t.Writer.StateElement(t.Writer.State.String))}},{key:"WriteStringEnd",value:function(){this.Assert(this.state==t.Writer.State.String),this._stateStack.pop(),this._addToCurrentObject(this._currentString),this._currentString=null}},{key:"WriteStringInner",value:function(e){this.Assert(this.state===t.Writer.State.String),null!==e?this._currentString+=e:console.error("Warning: trying to write a null string")}},{key:"toString",value:function(){return null===this._jsonObject?"":JSON.stringify(this._jsonObject)}},{key:"StartNewObject",value:function(e){this.Assert(e?this.state===t.Writer.State.None||this.state===t.Writer.State.Property||this.state===t.Writer.State.Array:this.state===t.Writer.State.Property||this.state===t.Writer.State.Array),this.state===t.Writer.State.Property&&this.Assert(0===this.childCount),this.state!==t.Writer.State.Array&&this.state!==t.Writer.State.Property||this.IncrementChildCount()}},{key:"state",get:function(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1].type:t.Writer.State.None}},{key:"childCount",get:function(){return this._stateStack.length>0?this._stateStack[this._stateStack.length-1].childCount:0}},{key:"currentCollection",get:function(){return this._collectionStack.length>0?this._collectionStack[this._collectionStack.length-1]:null}},{key:"currentPropertyName",get:function(){return this._propertyNameStack.length>0?this._propertyNameStack[this._propertyNameStack.length-1]:null}},{key:"IncrementChildCount",value:function(){this.Assert(this._stateStack.length>0);var t=this._stateStack.pop();t.childCount++,this._stateStack.push(t)}},{key:"Assert",value:function(t){if(!t)throw Error("Assert failed while writing JSON")}},{key:"_addToCurrentObject",value:function(e){this.Assert(null!==this.currentCollection),this.state===t.Writer.State.Array?(this.Assert(Array.isArray(this.currentCollection)),this.currentCollection.push(e)):this.state===t.Writer.State.Property&&(this.Assert(!Array.isArray(this.currentCollection)),this.Assert(null!==this.currentPropertyName),this.currentCollection[this.currentPropertyName]=e,this._propertyNameStack.pop())}}]),e}();t.Writer=e,function(e){var n;(n=e.State||(e.State={}))[n.None=0]="None",n[n.Object=1]="Object",n[n.Array=2]="Array",n[n.Property=3]="Property",n[n.PropertyName=4]="PropertyName",n[n.String=5]="String",e.StateElement=function(){return m((function(e){this.type=t.Writer.State.None,this.childCount=0,this.type=e}))}()}(e=t.Writer||(t.Writer={}))}(rt||(rt={}));var at=function(){function t(){var t=arguments[1];if(this.name=arguments[0],this.callStack=new tt(t),arguments[2]){var e=arguments[2];this.callStack.SetJsonToken(e.callstack,t),this.outputStream=Z.JArrayToRuntimeObjList(e.outputStream),this.currentChoices=Z.JArrayToRuntimeObjList(e.currentChoices);var n=e.choiceThreads;void 0!==n&&this.LoadFlowChoiceThreads(n,t)}else this.outputStream=[],this.currentChoices=[]}return m(t,[{key:"WriteJson",value:function(t){var e=this;t.WriteObjectStart(),t.WriteProperty("callstack",(function(t){return e.callStack.WriteJson(t)})),t.WriteProperty("outputStream",(function(t){return Z.WriteListRuntimeObjs(t,e.outputStream)}));var n,i=!1,r=v(this.currentChoices);try{for(r.s();!(n=r.n()).done;){var a=n.value;if(null===a.threadAtGeneration)return d("c.threadAtGeneration");a.originalThreadIndex=a.threadAtGeneration.threadIndex,null===this.callStack.ThreadWithIndex(a.originalThreadIndex)&&(i||(i=!0,t.WritePropertyStart("choiceThreads"),t.WriteObjectStart()),t.WritePropertyStart(a.originalThreadIndex),a.threadAtGeneration.WriteJson(t),t.WritePropertyEnd())}}catch(t){r.e(t)}finally{r.f()}i&&(t.WriteObjectEnd(),t.WritePropertyEnd()),t.WriteProperty("currentChoices",(function(t){t.WriteArrayStart();var n,i=v(e.currentChoices);try{for(i.s();!(n=i.n()).done;)Z.WriteChoice(t,n.value)}catch(t){i.e(t)}finally{i.f()}t.WriteArrayEnd()})),t.WriteObjectEnd()}},{key:"LoadFlowChoiceThreads",value:function(t,e){var n,i=v(this.currentChoices);try{for(i.s();!(n=i.n()).done;){var r=n.value,a=this.callStack.ThreadWithIndex(r.originalThreadIndex);if(null!==a)r.threadAtGeneration=a.Copy();else{var o=t["".concat(r.originalThreadIndex)];r.threadAtGeneration=new tt.Thread(o,e)}}}catch(t){i.e(t)}finally{i.f()}}}]),t}(),ot=function(){function t(t){this.kInkSaveStateVersion=10,this.kMinCompatibleLoadVersion=8,this.onDidLoadState=null,this._currentErrors=null,this._currentWarnings=null,this.divertedPointer=M.Null,this._currentTurnIndex=0,this.storySeed=0,this.previousRandom=0,this.didSafeExit=!1,this._currentText=null,this._currentTags=null,this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0,this._patch=null,this._aliveFlowNames=null,this._namedFlows=null,this.kDefaultFlowName="DEFAULT_FLOW",this._aliveFlowNamesDirty=!0,this.story=t,this._currentFlow=new at(this.kDefaultFlowName,t),this.OutputStreamDirty(),this._aliveFlowNamesDirty=!0,this._evaluationStack=[],this._variablesState=new et(this.callStack,t.listDefinitions),this._visitCounts=new Map,this._turnIndices=new Map,this.currentTurnIndex=-1;var e=(new Date).getTime();this.storySeed=new nt(e).next()%100,this.previousRandom=0,this.GoToStart()}return m(t,[{key:"ToJson",value:function(){var t=new rt.Writer;return this.WriteJson(t),t.toString()}},{key:"toJson",value:function(){return this.ToJson(arguments.length>0&&void 0!==arguments[0]&&arguments[0])}},{key:"LoadJson",value:function(t){var e=rt.TextToDictionary(t);this.LoadJsonObj(e),null!==this.onDidLoadState&&this.onDidLoadState()}},{key:"VisitCountAtPathString",value:function(t){var e;if(null!==this._patch){var n=this.story.ContentAtPath(new b(t)).container;if(null===n)throw new Error("Content at path not found: "+t);if((e=this._patch.TryGetVisitCount(n,0)).exists)return e.result}return(e=p(this._visitCounts,t,null)).exists?e.result:0}},{key:"VisitCountForContainer",value:function(t){if(null===t)return d("container");if(!t.visitsShouldBeCounted)return this.story.Error("Read count for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),0;if(null!==this._patch){var e=this._patch.TryGetVisitCount(t,0);if(e.exists)return e.result}var n=t.path.toString(),i=p(this._visitCounts,n,null);return i.exists?i.result:0}},{key:"IncrementVisitCountForContainer",value:function(t){if(null!==this._patch){var e=this.VisitCountForContainer(t);return e++,void this._patch.SetVisitCount(t,e)}var n=t.path.toString(),i=p(this._visitCounts,n,null);this._visitCounts.set(n,i.exists?i.result+1:1)}},{key:"RecordTurnIndexVisitToContainer",value:function(t){if(null===this._patch){var e=t.path.toString();this._turnIndices.set(e,this.currentTurnIndex)}else this._patch.SetTurnIndex(t,this.currentTurnIndex)}},{key:"TurnsSinceForContainer",value:function(t){if(t.turnIndexShouldBeCounted||this.story.Error("TURNS_SINCE() for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),null!==this._patch){var e=this._patch.TryGetTurnIndex(t,0);if(e.exists)return this.currentTurnIndex-e.result}var n=t.path.toString(),i=p(this._turnIndices,n,0);return i.exists?this.currentTurnIndex-i.result:-1}},{key:"callstackDepth",get:function(){return this.callStack.depth}},{key:"outputStream",get:function(){return this._currentFlow.outputStream}},{key:"currentChoices",get:function(){return this.canContinue?[]:this._currentFlow.currentChoices}},{key:"generatedChoices",get:function(){return this._currentFlow.currentChoices}},{key:"currentErrors",get:function(){return this._currentErrors}},{key:"currentWarnings",get:function(){return this._currentWarnings}},{key:"variablesState",get:function(){return this._variablesState},set:function(t){this._variablesState=t}},{key:"callStack",get:function(){return this._currentFlow.callStack}},{key:"evaluationStack",get:function(){return this._evaluationStack}},{key:"currentTurnIndex",get:function(){return this._currentTurnIndex},set:function(t){this._currentTurnIndex=t}},{key:"currentPathString",get:function(){var t=this.currentPointer;return t.isNull?null:null===t.path?d("pointer.path"):t.path.toString()}},{key:"currentPointer",get:function(){return this.callStack.currentElement.currentPointer.copy()},set:function(t){this.callStack.currentElement.currentPointer=t.copy()}},{key:"previousPointer",get:function(){return this.callStack.currentThread.previousPointer.copy()},set:function(t){this.callStack.currentThread.previousPointer=t.copy()}},{key:"canContinue",get:function(){return!this.currentPointer.isNull&&!this.hasError}},{key:"hasError",get:function(){return null!=this.currentErrors&&this.currentErrors.length>0}},{key:"hasWarning",get:function(){return null!=this.currentWarnings&&this.currentWarnings.length>0}},{key:"currentText",get:function(){if(this._outputStreamTextDirty){var t,n=new T,i=!1,r=v(this.outputStream);try{for(r.s();!(t=r.n()).done;){var a=t.value,o=e(a,W);if(i||null===o){var s=e(a,G);null!==s&&(s.commandType==G.CommandType.BeginTag?i=!0:s.commandType==G.CommandType.EndTag&&(i=!1))}else n.Append(o.value)}}catch(t){r.e(t)}finally{r.f()}this._currentText=this.CleanOutputWhitespace(n.toString()),this._outputStreamTextDirty=!1}return this._currentText}},{key:"CleanOutputWhitespace",value:function(t){for(var e=new T,n=-1,i=0,r=0;r<t.length;r++){var a=t.charAt(r),o=" "==a||"\t"==a;o&&-1==n&&(n=r),o||("\n"!=a&&n>0&&n!=i&&e.Append(" "),n=-1),"\n"==a&&(i=r+1),o||e.Append(a)}return e.toString()}},{key:"currentTags",get:function(){if(this._outputStreamTagsDirty){this._currentTags=[];var t,n=!1,i=new T,r=v(this.outputStream);try{for(r.s();!(t=r.n()).done;){var a=t.value,o=e(a,G);if(null!=o){if(o.commandType==G.CommandType.BeginTag){if(n&&i.Length>0){var s=this.CleanOutputWhitespace(i.toString());this._currentTags.push(s),i.Clear()}n=!0}else if(o.commandType==G.CommandType.EndTag){if(i.Length>0){var u=this.CleanOutputWhitespace(i.toString());this._currentTags.push(u),i.Clear()}n=!1}}else if(n){var l=e(a,W);null!==l&&i.Append(l.value)}else{var h=e(a,X);null!=h&&null!=h.text&&h.text.length>0&&this._currentTags.push(h.text)}}}catch(t){r.e(t)}finally{r.f()}if(i.Length>0){var c=this.CleanOutputWhitespace(i.toString());this._currentTags.push(c),i.Clear()}this._outputStreamTagsDirty=!1}return this._currentTags}},{key:"currentFlowName",get:function(){return this._currentFlow.name}},{key:"currentFlowIsDefaultFlow",get:function(){return this._currentFlow.name==this.kDefaultFlowName}},{key:"aliveFlowNames",get:function(){if(this._aliveFlowNamesDirty){if(this._aliveFlowNames=[],null!=this._namedFlows){var t,e=v(this._namedFlows.keys());try{for(e.s();!(t=e.n()).done;){var n=t.value;n!=this.kDefaultFlowName&&this._aliveFlowNames.push(n)}}catch(t){e.e(t)}finally{e.f()}}this._aliveFlowNamesDirty=!1}return this._aliveFlowNames}},{key:"inExpressionEvaluation",get:function(){return this.callStack.currentElement.inExpressionEvaluation},set:function(t){this.callStack.currentElement.inExpressionEvaluation=t}},{key:"GoToStart",value:function(){this.callStack.currentElement.currentPointer=M.StartOf(this.story.mainContentContainer)}},{key:"SwitchFlow_Internal",value:function(t){if(null===t)throw new Error("Must pass a non-null string to Story.SwitchFlow");if(null===this._namedFlows&&(this._namedFlows=new Map,this._namedFlows.set(this.kDefaultFlowName,this._currentFlow)),t!==this._currentFlow.name){var e,n=p(this._namedFlows,t,null);n.exists?e=n.result:(e=new at(t,this.story),this._namedFlows.set(t,e),this._aliveFlowNamesDirty=!0),this._currentFlow=e,this.variablesState.callStack=this._currentFlow.callStack,this.OutputStreamDirty()}}},{key:"SwitchToDefaultFlow_Internal",value:function(){null!==this._namedFlows&&this.SwitchFlow_Internal(this.kDefaultFlowName)}},{key:"RemoveFlow_Internal",value:function(t){if(null===t)throw new Error("Must pass a non-null string to Story.DestroyFlow");if(t===this.kDefaultFlowName)throw new Error("Cannot destroy default flow");if(this._currentFlow.name===t&&this.SwitchToDefaultFlow_Internal(),null===this._namedFlows)return d("this._namedFlows");this._namedFlows.delete(t),this._aliveFlowNamesDirty=!0}},{key:"CopyAndStartPatching",value:function(){var e,i,r,a,o,s=new t(this.story);if(s._patch=new it(this._patch),s._currentFlow.name=this._currentFlow.name,s._currentFlow.callStack=new tt(this._currentFlow.callStack),(e=s._currentFlow.currentChoices).push.apply(e,f(this._currentFlow.currentChoices)),(i=s._currentFlow.outputStream).push.apply(i,f(this._currentFlow.outputStream)),s.OutputStreamDirty(),null!==this._namedFlows){s._namedFlows=new Map;var u,l=v(this._namedFlows);try{for(l.s();!(u=l.n()).done;){var h=n(u.value,2);s._namedFlows.set(h[0],h[1]),s._aliveFlowNamesDirty=!0}}catch(t){l.e(t)}finally{l.f()}s._namedFlows.set(this._currentFlow.name,s._currentFlow)}return this.hasError&&(s._currentErrors=[],(r=s._currentErrors).push.apply(r,f(this.currentErrors||[]))),this.hasWarning&&(s._currentWarnings=[],(a=s._currentWarnings).push.apply(a,f(this.currentWarnings||[]))),s.variablesState=this.variablesState,s.variablesState.callStack=s.callStack,s.variablesState.patch=s._patch,(o=s.evaluationStack).push.apply(o,f(this.evaluationStack)),this.divertedPointer.isNull||(s.divertedPointer=this.divertedPointer.copy()),s.previousPointer=this.previousPointer.copy(),s._visitCounts=this._visitCounts,s._turnIndices=this._turnIndices,s.currentTurnIndex=this.currentTurnIndex,s.storySeed=this.storySeed,s.previousRandom=this.previousRandom,s.didSafeExit=this.didSafeExit,s}},{key:"RestoreAfterPatch",value:function(){this.variablesState.callStack=this.callStack,this.variablesState.patch=this._patch}},{key:"ApplyAnyPatch",value:function(){if(null!==this._patch){this.variablesState.ApplyPatch();var t,e=v(this._patch.visitCounts);try{for(e.s();!(t=e.n()).done;){var i=n(t.value,2);this.ApplyCountChanges(i[0],i[1],!0)}}catch(t){e.e(t)}finally{e.f()}var r,a=v(this._patch.turnIndices);try{for(a.s();!(r=a.n()).done;){var o=n(r.value,2);this.ApplyCountChanges(o[0],o[1],!1)}}catch(t){a.e(t)}finally{a.f()}this._patch=null}}},{key:"ApplyCountChanges",value:function(t,e,n){(n?this._visitCounts:this._turnIndices).set(t.path.toString(),e)}},{key:"WriteJson",value:function(t){var e=this;if(t.WriteObjectStart(),t.WritePropertyStart("flows"),t.WriteObjectStart(),null!==this._namedFlows){var i,r=v(this._namedFlows);try{var a=function(){var e=n(i.value,2),r=e[1];t.WriteProperty(e[0],(function(t){return r.WriteJson(t)}))};for(r.s();!(i=r.n()).done;)a()}catch(t){r.e(t)}finally{r.f()}}else t.WriteProperty(this._currentFlow.name,(function(t){return e._currentFlow.WriteJson(t)}));if(t.WriteObjectEnd(),t.WritePropertyEnd(),t.WriteProperty("currentFlowName",this._currentFlow.name),t.WriteProperty("variablesState",(function(t){return e.variablesState.WriteJson(t)})),t.WriteProperty("evalStack",(function(t){return Z.WriteListRuntimeObjs(t,e.evaluationStack)})),!this.divertedPointer.isNull){if(null===this.divertedPointer.path)return d("divertedPointer");t.WriteProperty("currentDivertTarget",this.divertedPointer.path.componentsString)}t.WriteProperty("visitCounts",(function(t){return Z.WriteIntDictionary(t,e._visitCounts)})),t.WriteProperty("turnIndices",(function(t){return Z.WriteIntDictionary(t,e._turnIndices)})),t.WriteIntProperty("turnIdx",this.currentTurnIndex),t.WriteIntProperty("storySeed",this.storySeed),t.WriteIntProperty("previousRandom",this.previousRandom),t.WriteIntProperty("inkSaveVersion",this.kInkSaveStateVersion),t.WriteIntProperty("inkFormatVersion",ut.inkVersionCurrent),t.WriteObjectEnd()}},{key:"LoadJsonObj",value:function(t){var e=t,i=e.inkSaveVersion;if(null==i)throw new Error("ink save format incorrect, can't load.");if(parseInt(i)<this.kMinCompatibleLoadVersion)throw new Error("Ink save format isn't compatible with the current version (saw '"+i+"', but minimum is "+this.kMinCompatibleLoadVersion+"), so can't load.");var r=e.flows;if(null!=r){var a=r;1===Object.keys(a).length?this._namedFlows=null:null===this._namedFlows?this._namedFlows=new Map:this._namedFlows.clear();for(var o=0,s=Object.entries(a);o<s.length;o++){var u=n(s[o],2),l=u[0],h=u[1],c=new at(l,this.story,h);if(1===Object.keys(a).length)this._currentFlow=new at(l,this.story,h);else{if(null===this._namedFlows)return d("this._namedFlows");this._namedFlows.set(l,c)}}null!=this._namedFlows&&this._namedFlows.size>1&&(this._currentFlow=this._namedFlows.get(e.currentFlowName))}else this._namedFlows=null,this._currentFlow.name=this.kDefaultFlowName,this._currentFlow.callStack.SetJsonToken(e.callstackThreads,this.story),this._currentFlow.outputStream=Z.JArrayToRuntimeObjList(e.outputStream),this._currentFlow.currentChoices=Z.JArrayToRuntimeObjList(e.currentChoices),this._currentFlow.LoadFlowChoiceThreads(e.choiceThreads,this.story);this.OutputStreamDirty(),this._aliveFlowNamesDirty=!0,this.variablesState.SetJsonToken(e.variablesState),this.variablesState.callStack=this._currentFlow.callStack,this._evaluationStack=Z.JArrayToRuntimeObjList(e.evalStack);var f=e.currentDivertTarget;if(null!=f){var v=new b(f.toString());this.divertedPointer=this.story.PointerAtPath(v)}this._visitCounts=Z.JObjectToIntDictionary(e.visitCounts),this._turnIndices=Z.JObjectToIntDictionary(e.turnIndices),this.currentTurnIndex=parseInt(e.turnIdx),this.storySeed=parseInt(e.storySeed),this.previousRandom=parseInt(e.previousRandom)}},{key:"ResetErrors",value:function(){this._currentErrors=null,this._currentWarnings=null}},{key:"ResetOutput",value:function(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.outputStream.length=0,null!==e&&(t=this.outputStream).push.apply(t,f(e)),this.OutputStreamDirty()}},{key:"PushToOutputStream",value:function(t){var n=e(t,W);if(null!==n){var i=this.TrySplittingHeadTailWhitespace(n);if(null!==i){var r,a=v(i);try{for(a.s();!(r=a.n()).done;)this.PushToOutputStreamIndividual(r.value)}catch(t){a.e(t)}finally{a.f()}return void this.OutputStreamDirty()}}this.PushToOutputStreamIndividual(t),this.OutputStreamDirty()}},{key:"PopFromOutputStream",value:function(t){this.outputStream.splice(this.outputStream.length-t,t),this.OutputStreamDirty()}},{key:"TrySplittingHeadTailWhitespace",value:function(t){var e=t.value;if(null===e)return d("single.value");for(var n=-1,i=-1,r=0;r<e.length;r++){var a=e[r];if("\n"!=a){if(" "==a||"\t"==a)continue;break}-1==n&&(n=r),i=r}for(var o=-1,s=-1,u=e.length-1;u>=0;u--){var l=e[u];if("\n"!=l){if(" "==l||"\t"==l)continue;break}-1==o&&(o=u),s=u}if(-1==n&&-1==o)return null;var h=[],c=0,f=e.length;if(-1!=n){if(n>0){var v=new W(e.substring(0,n));h.push(v)}h.push(new W("\n")),c=i+1}if(-1!=o&&(f=s),f>c){var p=e.substring(c,f);h.push(new W(p))}if(-1!=o&&s>i&&(h.push(new W("\n")),o<e.length-1)){var y=new W(e.substring(o+1,o+1+(e.length-o-1)));h.push(y)}return h}},{key:"PushToOutputStreamIndividual",value:function(t){var n=e(t,B),i=e(t,W),r=!0;if(n)this.TrimNewlinesFromOutputStream(),r=!0;else if(i){var a=-1,o=this.callStack.currentElement;o.type==k.Function&&(a=o.functionStartInOutputStream);for(var s=-1,u=this.outputStream.length-1;u>=0;u--){var l=this.outputStream[u],h=l instanceof G?l:null;if(null!=(l instanceof B?l:null)){s=u;break}if(null!=h&&h.commandType==G.CommandType.BeginString){u>=a&&(a=-1);break}}if(-1!=(-1!=s&&-1!=a?Math.min(a,s):-1!=s?s:a)){if(i.isNewline)r=!1;else if(i.isNonWhitespace&&(s>-1&&this.RemoveExistingGlue(),a>-1))for(var c=this.callStack.elements,f=c.length-1;f>=0;f--){var v=c[f];if(v.type!=k.Function)break;v.functionStartInOutputStream=-1}}else i.isNewline&&(!this.outputStreamEndsInNewline&&this.outputStreamContainsContent||(r=!1))}if(r){if(null===t)return d("obj");this.outputStream.push(t),this.OutputStreamDirty()}}},{key:"TrimNewlinesFromOutputStream",value:function(){for(var t=-1,n=this.outputStream.length-1;n>=0;){var i=this.outputStream[n],r=e(i,G),a=e(i,W);if(null!=r||null!=a&&a.isNonWhitespace)break;null!=a&&a.isNewline&&(t=n),n--}if(t>=0)for(n=t;n<this.outputStream.length;)e(this.outputStream[n],W)?this.outputStream.splice(n,1):n++;this.OutputStreamDirty()}},{key:"RemoveExistingGlue",value:function(){for(var t=this.outputStream.length-1;t>=0;t--){var e=this.outputStream[t];if(e instanceof B)this.outputStream.splice(t,1);else if(e instanceof G)break}this.OutputStreamDirty()}},{key:"outputStreamEndsInNewline",get:function(){if(this.outputStream.length>0)for(var t=this.outputStream.length-1;t>=0&&!(this.outputStream[t]instanceof G);t--){var e=this.outputStream[t];if(e instanceof W){if(e.isNewline)return!0;if(e.isNonWhitespace)break}}return!1}},{key:"outputStreamContainsContent",get:function(){var t,e=v(this.outputStream);try{for(e.s();!(t=e.n()).done;)if(t.value instanceof W)return!0}catch(t){e.e(t)}finally{e.f()}return!1}},{key:"inStringEvaluation",get:function(){for(var t=this.outputStream.length-1;t>=0;t--){var n=e(this.outputStream[t],G);if(n instanceof G&&n.commandType==G.CommandType.BeginString)return!0}return!1}},{key:"PushEvaluationStack",value:function(t){var n=e(t,j);if(n){var i=n.value;if(null===i)return d("rawList");if(null!=i.originNames){i.origins||(i.origins=[]),i.origins.length=0;var r,a=v(i.originNames);try{for(a.s();!(r=a.n()).done;){var o=r.value;if(null===this.story.listDefinitions)return d("StoryState.story.listDefinitions");var s=this.story.listDefinitions.TryListGetDefinition(o,null);if(null===s.result)return d("StoryState def.result");i.origins.indexOf(s.result)<0&&i.origins.push(s.result)}}catch(t){a.e(t)}finally{a.f()}}}if(null===t)return d("obj");this.evaluationStack.push(t)}},{key:"PopEvaluationStack",value:function(t){if(void 0===t)return h(this.evaluationStack.pop());if(t>this.evaluationStack.length)throw new Error("trying to pop too many objects");return h(this.evaluationStack.splice(this.evaluationStack.length-t,t))}},{key:"PeekEvaluationStack",value:function(){return this.evaluationStack[this.evaluationStack.length-1]}},{key:"ForceEnd",value:function(){this.callStack.Reset(),this._currentFlow.currentChoices.length=0,this.currentPointer=M.Null,this.previousPointer=M.Null,this.didSafeExit=!0}},{key:"TrimWhitespaceFromFunctionEnd",value:function(){y.Assert(this.callStack.currentElement.type==k.Function);var t=this.callStack.currentElement.functionStartInOutputStream;-1==t&&(t=0);for(var n=this.outputStream.length-1;n>=t;n--){var i=this.outputStream[n],r=e(i,W),a=e(i,G);if(null!=r){if(a)break;if(!r.isNewline&&!r.isInlineWhitespace)break;this.outputStream.splice(n,1),this.OutputStreamDirty()}}}},{key:"PopCallStack",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.callStack.currentElement.type==k.Function&&this.TrimWhitespaceFromFunctionEnd(),this.callStack.Pop(t)}},{key:"SetChosenPath",value:function(t,e){this._currentFlow.currentChoices.length=0;var n=this.story.PointerAtPath(t);n.isNull||-1!=n.index||(n.index=0),this.currentPointer=n,e&&this.currentTurnIndex++}},{key:"StartFunctionEvaluationFromGame",value:function(t,e){this.callStack.Push(k.FunctionEvaluationFromGame,this.evaluationStack.length),this.callStack.currentElement.currentPointer=M.StartOf(t),this.PassArgumentsToEvaluationStack(e)}},{key:"PassArgumentsToEvaluationStack",value:function(t){if(null!==t)for(var e=0;e<t.length;e++){if(!("number"==typeof t[e]||"string"==typeof t[e]||"boolean"==typeof t[e]||t[e]instanceof O))throw new Error((h(arguments[e]),"null"));this.PushEvaluationStack(A.Create(t[e]))}}},{key:"TryExitFunctionEvaluationFromGame",value:function(){return this.callStack.currentElement.type==k.FunctionEvaluationFromGame&&(this.currentPointer=M.Null,this.didSafeExit=!0,!0)}},{key:"CompleteFunctionEvaluationFromGame",value:function(){if(this.callStack.currentElement.type!=k.FunctionEvaluationFromGame)throw new Error("Expected external function evaluation to be complete. Stack trace: "+this.callStack.callStackTrace);for(var t=this.callStack.currentElement.evaluationStackHeightWhenPushed,e=null;this.evaluationStack.length>t;){var n=this.PopEvaluationStack();null===e&&(e=n)}if(this.PopCallStack(k.FunctionEvaluationFromGame),e){if(e instanceof z)return null;var i=u(e,A);return i.valueType==S.DivertTarget?i.valueObject.toString():i.valueObject}return null}},{key:"AddError",value:function(t,e){e?(null==this._currentWarnings&&(this._currentWarnings=[]),this._currentWarnings.push(t)):(null==this._currentErrors&&(this._currentErrors=[]),this._currentErrors.push(t))}},{key:"OutputStreamDirty",value:function(){this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0}}]),t}(),st=function(){function t(){this.startTime=void 0}return m(t,[{key:"ElapsedMilliseconds",get:function(){return void 0===this.startTime?0:(new Date).getTime()-this.startTime}},{key:"Start",value:function(){this.startTime=(new Date).getTime()}},{key:"Stop",value:function(){this.startTime=void 0}}]),t}();!function(t){t[t.Author=0]="Author",t[t.Warning=1]="Warning",t[t.Error=2]="Error"}(C||(C={})),Number.isInteger||(Number.isInteger=function(t){return"number"==typeof t&&isFinite(t)&&t>-9007199254740992&&t<9007199254740992&&Math.floor(t)===t});var ut=function(t){function a(){var t;(t=o.call(this)).inkVersionMinimumCompatible=18,t.onError=null,t.onDidContinue=null,t.onMakeChoice=null,t.onEvaluateFunction=null,t.onCompleteEvaluateFunction=null,t.onChoosePathString=null,t._prevContainers=[],t.allowExternalFunctionFallbacks=!1,t._listDefinitions=null,t._variableObservers=null,t._hasValidatedExternals=!1,t._temporaryEvaluationContainer=null,t._asyncContinueActive=!1,t._stateSnapshotAtLastNewline=null,t._sawLookaheadUnsafeFunctionAfterNewline=!1,t._recursiveContinueCount=0,t._asyncSaving=!1,t._profiler=null;var e=null,n=null;if(arguments[0]instanceof D?(void 0!==arguments[1]&&(e=arguments[1]),t._mainContentContainer=arguments[0]):n="string"==typeof arguments[0]?rt.TextToDictionary(arguments[0]):arguments[0],null!=e&&(t._listDefinitions=new Q(e)),t._externals=new Map,null!==n){var i=n,r=i.inkVersion;if(null==r)throw new Error("ink version number not found. Are you sure it's a valid .ink.json file?");var s=parseInt(r);if(s>a.inkVersionCurrent)throw new Error("Version of ink used to build story was newer than the current version of the engine");if(s<t.inkVersionMinimumCompatible)throw new Error("Version of ink used to build story is too old to be loaded by this version of the engine");s!=a.inkVersionCurrent&&console.warn("WARNING: Version of ink used to build story doesn't match current version of engine. Non-critical, but recommend synchronising.");var l,h=i.root;if(null==h)throw new Error("Root node for ink not found. Are you sure it's a valid .ink.json file?");(l=i.listDefs)&&(t._listDefinitions=Z.JTokenToListDefinitions(l)),t._mainContentContainer=u(Z.JTokenToRuntimeObject(h),D),t.ResetState()}return t}i(a,t);var o=r(a);return m(a,[{key:"currentChoices",get:function(){var t=[];if(null===this._state)return d("this._state");var e,n=v(this._state.currentChoices);try{for(n.s();!(e=n.n()).done;){var i=e.value;i.isInvisibleDefault||(i.index=t.length,t.push(i))}}catch(t){n.e(t)}finally{n.f()}return t}},{key:"currentText",get:function(){return this.IfAsyncWeCant("call currentText since it's a work in progress"),this.state.currentText}},{key:"currentTags",get:function(){return this.IfAsyncWeCant("call currentTags since it's a work in progress"),this.state.currentTags}},{key:"currentErrors",get:function(){return this.state.currentErrors}},{key:"currentWarnings",get:function(){return this.state.currentWarnings}},{key:"currentFlowName",get:function(){return this.state.currentFlowName}},{key:"currentFlowIsDefaultFlow",get:function(){return this.state.currentFlowIsDefaultFlow}},{key:"aliveFlowNames",get:function(){return this.state.aliveFlowNames}},{key:"hasError",get:function(){return this.state.hasError}},{key:"hasWarning",get:function(){return this.state.hasWarning}},{key:"variablesState",get:function(){return this.state.variablesState}},{key:"listDefinitions",get:function(){return this._listDefinitions}},{key:"state",get:function(){return this._state}},{key:"StartProfiling",value:function(){}},{key:"EndProfiling",value:function(){}},{key:"ToJson",value:function(t){var e=this,i=!1;if(t||(i=!0,t=new rt.Writer),t.WriteObjectStart(),t.WriteIntProperty("inkVersion",a.inkVersionCurrent),t.WriteProperty("root",(function(t){return Z.WriteRuntimeContainer(t,e._mainContentContainer)})),null!=this._listDefinitions){t.WritePropertyStart("listDefs"),t.WriteObjectStart();var r,o=v(this._listDefinitions.lists);try{for(o.s();!(r=o.n()).done;){var s=r.value;t.WritePropertyStart(s.name),t.WriteObjectStart();var u,l=v(s.items);try{for(l.s();!(u=l.n()).done;){var h=n(u.value,2),c=h[1],f=E.fromSerializedKey(h[0]);t.WriteIntProperty(f.itemName,c)}}catch(t){l.e(t)}finally{l.f()}t.WriteObjectEnd(),t.WritePropertyEnd()}}catch(t){o.e(t)}finally{o.f()}t.WriteObjectEnd(),t.WritePropertyEnd()}if(t.WriteObjectEnd(),i)return t.toString()}},{key:"ResetState",value:function(){this.IfAsyncWeCant("ResetState"),this._state=new ot(this),this._state.variablesState.ObserveVariableChange(this.VariableStateDidChangeEvent.bind(this)),this.ResetGlobals()}},{key:"ResetErrors",value:function(){if(null===this._state)return d("this._state");this._state.ResetErrors()}},{key:"ResetCallstack",value:function(){if(this.IfAsyncWeCant("ResetCallstack"),null===this._state)return d("this._state");this._state.ForceEnd()}},{key:"ResetGlobals",value:function(){if(this._mainContentContainer.namedContent.get("global decl")){var t=this.state.currentPointer.copy();this.ChoosePath(new b("global decl"),!1),this.ContinueInternal(),this.state.currentPointer=t}this.state.variablesState.SnapshotDefaultGlobals()}},{key:"SwitchFlow",value:function(t){if(this.IfAsyncWeCant("switch flow"),this._asyncSaving)throw new Error("Story is already in background saving mode, can't switch flow to "+t);this.state.SwitchFlow_Internal(t)}},{key:"RemoveFlow",value:function(t){this.state.RemoveFlow_Internal(t)}},{key:"SwitchToDefaultFlow",value:function(){this.state.SwitchToDefaultFlow_Internal()}},{key:"Continue",value:function(){return this.ContinueAsync(0),this.currentText}},{key:"canContinue",get:function(){return this.state.canContinue}},{key:"asyncContinueComplete",get:function(){return!this._asyncContinueActive}},{key:"ContinueAsync",value:function(t){this._hasValidatedExternals||this.ValidateExternalBindings(),this.ContinueInternal(t)}},{key:"ContinueInternal",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;null!=this._profiler&&this._profiler.PreContinue();var e=t>0;if(this._recursiveContinueCount++,!this._asyncContinueActive){if(this._asyncContinueActive=e,!this.canContinue)throw new Error("Can't continue - should check canContinue before calling Continue");this._state.didSafeExit=!1,this._state.ResetOutput(),1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!0)}var n=new st;n.Start();var i=!1;this._sawLookaheadUnsafeFunctionAfterNewline=!1;do{try{i=this.ContinueSingleStep()}catch(t){if(!(t instanceof P))throw t;this.AddError(t.message,void 0,t.useEndLineNumber);break}if(i)break;if(this._asyncContinueActive&&n.ElapsedMilliseconds>t)break}while(this.canContinue);if(n.Stop(),!i&&this.canContinue||(null!==this._stateSnapshotAtLastNewline&&this.RestoreStateSnapshot(),this.canContinue||(this.state.callStack.canPopThread&&this.AddError("Thread available to pop, threads should always be flat by the end of evaluation?"),0!=this.state.generatedChoices.length||this.state.didSafeExit||null!=this._temporaryEvaluationContainer||(this.state.callStack.CanPop(k.Tunnel)?this.AddError("unexpectedly reached end of content. Do you need a '->->' to return from a tunnel?"):this.state.callStack.CanPop(k.Function)?this.AddError("unexpectedly reached end of content. Do you need a '~ return'?"):this.AddError(this.state.callStack.canPop?"unexpectedly reached end of content for unknown reason. Please debug compiler!":"ran out of content. Do you need a '-> DONE' or '-> END'?"))),this.state.didSafeExit=!1,this._sawLookaheadUnsafeFunctionAfterNewline=!1,1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!1),this._asyncContinueActive=!1,null!==this.onDidContinue&&this.onDidContinue()),this._recursiveContinueCount--,null!=this._profiler&&this._profiler.PostContinue(),this.state.hasError||this.state.hasWarning){if(null===this.onError){var r=new T;throw r.Append("Ink had "),this.state.hasError&&(r.Append("".concat(this.state.currentErrors.length)),r.Append(1==this.state.currentErrors.length?" error":"errors"),this.state.hasWarning&&r.Append(" and ")),this.state.hasWarning&&(r.Append("".concat(this.state.currentWarnings.length)),r.Append(1==this.state.currentWarnings.length?" warning":"warnings"),this.state.hasWarning&&r.Append(" and ")),r.Append(". It is strongly suggested that you assign an error handler to story.onError. The first issue was: "),r.Append(this.state.hasError?this.state.currentErrors[0]:this.state.currentWarnings[0]),new P(r.toString())}if(this.state.hasError){var a,o=v(this.state.currentErrors);try{for(o.s();!(a=o.n()).done;)this.onError(a.value,C.Error)}catch(t){o.e(t)}finally{o.f()}}if(this.state.hasWarning){var s,u=v(this.state.currentWarnings);try{for(u.s();!(s=u.n()).done;)this.onError(s.value,C.Warning)}catch(t){u.e(t)}finally{u.f()}}this.ResetErrors()}}},{key:"ContinueSingleStep",value:function(){if(null!=this._profiler&&this._profiler.PreStep(),this.Step(),null!=this._profiler&&this._profiler.PostStep(),this.canContinue||this.state.callStack.elementIsEvaluateFromGame||this.TryFollowDefaultInvisibleChoice(),null!=this._profiler&&this._profiler.PreSnapshot(),!this.state.inStringEvaluation){if(null!==this._stateSnapshotAtLastNewline){if(null===this._stateSnapshotAtLastNewline.currentTags)return d("this._stateAtLastNewline.currentTags");if(null===this.state.currentTags)return d("this.state.currentTags");var t=this.CalculateNewlineOutputStateChange(this._stateSnapshotAtLastNewline.currentText,this.state.currentText,this._stateSnapshotAtLastNewline.currentTags.length,this.state.currentTags.length);if(t==a.OutputStateChange.ExtendedBeyondNewline||this._sawLookaheadUnsafeFunctionAfterNewline)return this.RestoreStateSnapshot(),!0;t==a.OutputStateChange.NewlineRemoved&&this.DiscardSnapshot()}this.state.outputStreamEndsInNewline&&(this.canContinue?null==this._stateSnapshotAtLastNewline&&this.StateSnapshot():this.DiscardSnapshot())}return null!=this._profiler&&this._profiler.PostSnapshot(),!1}},{key:"CalculateNewlineOutputStateChange",value:function(t,e,n,i){if(null===t)return d("prevText");if(null===e)return d("currText");var r=e.length>=t.length&&t.length>0&&"\n"==e.charAt(t.length-1);if(n==i&&t.length==e.length&&r)return a.OutputStateChange.NoChange;if(!r)return a.OutputStateChange.NewlineRemoved;if(i>n)return a.OutputStateChange.ExtendedBeyondNewline;for(var o=t.length;o<e.length;o++){var s=e.charAt(o);if(" "!=s&&"\t"!=s)return a.OutputStateChange.ExtendedBeyondNewline}return a.OutputStateChange.NoChange}},{key:"ContinueMaximally",value:function(){this.IfAsyncWeCant("ContinueMaximally");for(var t=new T;this.canContinue;)t.Append(this.Continue());return t.toString()}},{key:"ContentAtPath",value:function(t){return this.mainContentContainer.ContentAtPath(t)}},{key:"KnotContainerWithName",value:function(t){var e=this.mainContentContainer.namedContent.get(t);return e instanceof D?e:null}},{key:"PointerAtPath",value:function(t){if(0==t.length)return M.Null;var e=new M,n=t.length,i=null;return null===t.lastComponent?d("path.lastComponent"):(t.lastComponent.isIndex?(i=this.mainContentContainer.ContentAtPath(t,void 0,n=t.length-1),e.container=i.container,e.index=t.lastComponent.index):(i=this.mainContentContainer.ContentAtPath(t),e.container=i.container,e.index=-1),null==i.obj||i.obj==this.mainContentContainer&&n>0?this.Error("Failed to find content at path '"+t+"', and no approximation of it was possible."):i.approximate&&this.Warning("Failed to find content at path '"+t+"', so it was approximated to: '"+i.obj.path+"'."),e)}},{key:"StateSnapshot",value:function(){this._stateSnapshotAtLastNewline=this._state,this._state=this._state.CopyAndStartPatching()}},{key:"RestoreStateSnapshot",value:function(){null===this._stateSnapshotAtLastNewline&&d("_stateSnapshotAtLastNewline"),this._stateSnapshotAtLastNewline.RestoreAfterPatch(),this._state=this._stateSnapshotAtLastNewline,this._stateSnapshotAtLastNewline=null,this._asyncSaving||this._state.ApplyAnyPatch()}},{key:"DiscardSnapshot",value:function(){this._asyncSaving||this._state.ApplyAnyPatch(),this._stateSnapshotAtLastNewline=null}},{key:"CopyStateForBackgroundThreadSave",value:function(){if(this.IfAsyncWeCant("start saving on a background thread"),this._asyncSaving)throw new Error("Story is already in background saving mode, can't call CopyStateForBackgroundThreadSave again!");var t=this._state;return this._state=this._state.CopyAndStartPatching(),this._asyncSaving=!0,t}},{key:"BackgroundSaveComplete",value:function(){null===this._stateSnapshotAtLastNewline&&this._state.ApplyAnyPatch(),this._asyncSaving=!1}},{key:"Step",value:function(){var t=!0,n=this.state.currentPointer.copy();if(!n.isNull){for(var i=e(n.Resolve(),D);i&&(this.VisitContainer(i,!0),0!=i.content.length);)i=e((n=M.StartOf(i)).Resolve(),D);this.state.currentPointer=n.copy(),null!=this._profiler&&this._profiler.Step(this.state.callStack);var r=n.Resolve(),a=this.PerformLogicAndFlowControl(r);if(!this.state.currentPointer.isNull){a&&(t=!1);var o=e(r,U);if(o){var s=this.ProcessChoice(o);s&&this.state.generatedChoices.push(s),r=null,t=!1}if(r instanceof D&&(t=!1),t){var u=e(r,L);if(u&&-1==u.contextIndex){var l=this.state.callStack.ContextForVariableNamed(u.variableName);r=new L(u.variableName,l)}this.state.inExpressionEvaluation?this.state.PushEvaluationStack(r):this.state.PushToOutputStream(r)}this.NextContent();var h=e(r,G);h&&h.commandType==G.CommandType.StartThread&&this.state.callStack.PushThread()}}}},{key:"VisitContainer",value:function(t,e){t.countingAtStartOnly&&!e||(t.visitsShouldBeCounted&&this.state.IncrementVisitCountForContainer(t),t.turnIndexShouldBeCounted&&this.state.RecordTurnIndexVisitToContainer(t))}},{key:"VisitChangedContainersDueToDivert",value:function(){var t=this.state.previousPointer.copy(),n=this.state.currentPointer.copy();if(!n.isNull&&-1!=n.index){if(this._prevContainers.length=0,!t.isNull)for(var i=e(t.Resolve(),D)||e(t.container,D);i;)this._prevContainers.push(i),i=e(i.parent,D);var r=n.Resolve();if(null!=r)for(var a=e(r.parent,D),o=!0;a&&(this._prevContainers.indexOf(a)<0||a.countingAtStartOnly);){var s=a.content.length>0&&r==a.content[0]&&o;s||(o=!1),this.VisitContainer(a,s),r=a,a=e(a.parent,D)}}}},{key:"PopChoiceStringAndTags",value:function(t){for(var n=u(this.state.PopEvaluationStack(),W);this.state.evaluationStack.length>0&&null!=e(this.state.PeekEvaluationStack(),X);){var i=e(this.state.PopEvaluationStack(),X);i&&t.push(i.text)}return n.value}},{key:"ProcessChoice",value:function(t){var e=!0;if(t.hasCondition){var n=this.state.PopEvaluationStack();this.IsTruthy(n)||(e=!1)}var i="",r="",a=[];if(t.hasChoiceOnlyContent&&(r=this.PopChoiceStringAndTags(a)||""),t.hasStartContent&&(i=this.PopChoiceStringAndTags(a)||""),t.onceOnly&&this.state.VisitCountForContainer(t.choiceTarget)>0&&(e=!1),!e)return null;var o=new $;return o.targetPath=t.pathOnChoice,o.sourcePath=t.path.toString(),o.isInvisibleDefault=t.isInvisibleDefault,o.threadAtGeneration=this.state.callStack.ForkThread(),o.tags=a.reverse(),o.text=(i+r).replace(/^[ \t]+|[ \t]+$/g,""),o}},{key:"IsTruthy",value:function(t){if(t instanceof A){var e=t;return e instanceof V?(this.Error("Shouldn't use a divert target (to "+e.targetPath+") as a conditional value. Did you intend a function call 'likeThis()' or a read count check 'likeThis'? (no arrows)"),!1):e.isTruthy}return!1}},{key:"PerformLogicAndFlowControl",value:function(t){if(null==t)return!1;if(t instanceof J){var n=t;if(n.isConditional){var i=this.state.PopEvaluationStack();if(!this.IsTruthy(i))return!0}if(n.hasVariableTarget){var r=n.variableDivertName,a=this.state.variablesState.GetVariableWithName(r);if(null==a)this.Error("Tried to divert using a target from a variable that could not be found ("+r+")");else if(!(a instanceof V)){var o=e(a,F),s="Tried to divert to a target from a variable, but the variable ("+r+") didn't contain a divert target, it ";this.Error(s+=o instanceof F&&0==o.value?"was empty/null (the value 0).":"contained '"+a+"'.")}var l=u(a,V);this.state.divertedPointer=this.PointerAtPath(l.targetPath)}else{if(n.isExternal)return this.CallExternalFunction(n.targetPathString,n.externalArgs),!0;this.state.divertedPointer=n.targetPointer.copy()}return n.pushesToStack&&this.state.callStack.Push(n.stackPushType,void 0,this.state.outputStream.length),this.state.divertedPointer.isNull&&!n.isExternal&&this.Error(n&&n.debugMetadata&&null!=n.debugMetadata.sourceName?"Divert target doesn't exist: "+n.debugMetadata.sourceName:"Divert resolution failed: "+n),!0}if(t instanceof G){var h=t;switch(h.commandType){case G.CommandType.EvalStart:this.Assert(!1===this.state.inExpressionEvaluation,"Already in expression evaluation?"),this.state.inExpressionEvaluation=!0;break;case G.CommandType.EvalEnd:this.Assert(!0===this.state.inExpressionEvaluation,"Not in expression evaluation mode"),this.state.inExpressionEvaluation=!1;break;case G.CommandType.EvalOutput:if(this.state.evaluationStack.length>0){var c=this.state.PopEvaluationStack();if(!(c instanceof z)){var f=new W(c.toString());this.state.PushToOutputStream(f)}}break;case G.CommandType.NoOp:break;case G.CommandType.Duplicate:this.state.PushEvaluationStack(this.state.PeekEvaluationStack());break;case G.CommandType.PopEvaluatedValue:this.state.PopEvaluationStack();break;case G.CommandType.PopFunction:case G.CommandType.PopTunnel:var p=h.commandType==G.CommandType.PopFunction?k.Function:k.Tunnel,y=null;if(p==k.Tunnel){var m=this.state.PopEvaluationStack();null===(y=e(m,V))&&this.Assert(m instanceof z,"Expected void if ->-> doesn't override target")}if(this.state.TryExitFunctionEvaluationFromGame())break;if(this.state.callStack.currentElement.type==p&&this.state.callStack.canPop)this.state.PopCallStack(),y&&(this.state.divertedPointer=this.PointerAtPath(y.targetPath));else{var g=new Map;g.set(k.Function,"function return statement (~ return)"),g.set(k.Tunnel,"tunnel onwards statement (->->)");var S=g.get(this.state.callStack.currentElement.type);this.state.callStack.canPop||(S="end of flow (-> END or choice)");var C="Found "+g.get(p)+", when expected "+S;this.Error(C)}break;case G.CommandType.BeginString:this.state.PushToOutputStream(h),this.Assert(!0===this.state.inExpressionEvaluation,"Expected to be in an expression when evaluating a string"),this.state.inExpressionEvaluation=!1;break;case G.CommandType.BeginTag:this.state.PushToOutputStream(h);break;case G.CommandType.EndTag:if(this.state.inStringEvaluation){for(var b=[],w=0,_=this.state.outputStream.length-1;_>=0;--_){var N=this.state.outputStream[_];w++;var I=e(N,G);if(null!=I){if(I.commandType==G.CommandType.BeginTag)break;this.Error("Unexpected ControlCommand while extracting tag from choice");break}N instanceof W&&b.push(N)}this.state.PopFromOutputStream(w);for(var x=new T,L=0,R=b;L<R.length;L++)x.Append(R[L].toString());var B=new X(this.state.CleanOutputWhitespace(x.toString()));this.state.PushEvaluationStack(B)}else this.state.PushToOutputStream(h);break;case G.CommandType.EndString:for(var U=[],$=[],Y=0,Q=this.state.outputStream.length-1;Q>=0;--Q){var Z=this.state.outputStream[Q];Y++;var tt=e(Z,G);if(tt&&tt.commandType==G.CommandType.BeginString)break;Z instanceof X&&$.push(Z),Z instanceof W&&U.push(Z)}this.state.PopFromOutputStream(Y);for(var et=0,it=$;et<it.length;et++)this.state.PushToOutputStream(it[et]);U=U.reverse();var rt,at=new T,ot=v(U);try{for(ot.s();!(rt=ot.n()).done;)at.Append(rt.value.toString())}catch(t){ot.e(t)}finally{ot.f()}this.state.inExpressionEvaluation=!0,this.state.PushEvaluationStack(new W(at.toString()));break;case G.CommandType.ChoiceCount:this.state.PushEvaluationStack(new F(this.state.generatedChoices.length));break;case G.CommandType.Turns:this.state.PushEvaluationStack(new F(this.state.currentTurnIndex+1));break;case G.CommandType.TurnsSince:case G.CommandType.ReadCount:var st=this.state.PopEvaluationStack();if(!(st instanceof V)){var ut="";st instanceof F&&(ut=". Did you accidentally pass a read count ('knot_name') instead of a target ('-> knot_name')?"),this.Error("TURNS_SINCE / READ_COUNT expected a divert target (knot, stitch, label name), but saw "+st+ut);break}var lt,ht=u(st,V),ct=e(this.ContentAtPath(ht.targetPath).correctObj,D);null!=ct?lt=h.commandType==G.CommandType.TurnsSince?this.state.TurnsSinceForContainer(ct):this.state.VisitCountForContainer(ct):(lt=h.commandType==G.CommandType.TurnsSince?-1:0,this.Warning("Failed to find container for "+h.toString()+" lookup at "+ht.targetPath.toString())),this.state.PushEvaluationStack(new F(lt));break;case G.CommandType.Random:var ft=e(this.state.PopEvaluationStack(),F),vt=e(this.state.PopEvaluationStack(),F);if(null==vt||vt instanceof F==0)return this.Error("Invalid value for minimum parameter of RANDOM(min, max)");if(null==ft||vt instanceof F==0)return this.Error("Invalid value for maximum parameter of RANDOM(min, max)");if(null===ft.value)return d("maxInt.value");if(null===vt.value)return d("minInt.value");var dt=ft.value-vt.value+1;(!isFinite(dt)||dt>Number.MAX_SAFE_INTEGER)&&(dt=Number.MAX_SAFE_INTEGER,this.Error("RANDOM was called with a range that exceeds the size that ink numbers can use.")),dt<=0&&this.Error("RANDOM was called with minimum as "+vt.value+" and maximum as "+ft.value+". The maximum must be larger");var pt=new nt(this.state.storySeed+this.state.previousRandom).next();this.state.PushEvaluationStack(new F(pt%dt+vt.value)),this.state.previousRandom=pt;break;case G.CommandType.SeedRandom:var yt=e(this.state.PopEvaluationStack(),F);if(null==yt||yt instanceof F==0)return this.Error("Invalid value passed to SEED_RANDOM");if(null===yt.value)return d("minInt.value");this.state.storySeed=yt.value,this.state.previousRandom=0,this.state.PushEvaluationStack(new z);break;case G.CommandType.VisitIndex:var mt=this.state.VisitCountForContainer(this.state.currentPointer.container)-1;this.state.PushEvaluationStack(new F(mt));break;case G.CommandType.SequenceShuffleIndex:var gt=this.NextSequenceShuffleIndex();this.state.PushEvaluationStack(new F(gt));break;case G.CommandType.StartThread:break;case G.CommandType.Done:this.state.callStack.canPopThread?this.state.callStack.PopThread():(this.state.didSafeExit=!0,this.state.currentPointer=M.Null);break;case G.CommandType.End:this.state.ForceEnd();break;case G.CommandType.ListFromInt:var St=e(this.state.PopEvaluationStack(),F),kt=u(this.state.PopEvaluationStack(),W);if(null===St)throw new P("Passed non-integer when creating a list element from a numerical value.");var Ct=null;if(null===this.listDefinitions)return d("this.listDefinitions");var bt=this.listDefinitions.TryListGetDefinition(kt.value,null);if(!bt.exists)throw new P("Failed to find LIST called "+kt.value);if(null===St.value)return d("minInt.value");var wt=bt.result.TryGetItemWithValue(St.value,E.Null);wt.exists&&(Ct=new j(wt.result,St.value)),null==Ct&&(Ct=new j),this.state.PushEvaluationStack(Ct);break;case G.CommandType.ListRange:var _t=e(this.state.PopEvaluationStack(),A),Tt=e(this.state.PopEvaluationStack(),A),Et=e(this.state.PopEvaluationStack(),j);if(null===Et||null===Tt||null===_t)throw new P("Expected list, minimum and maximum for LIST_RANGE");if(null===Et.value)return d("targetList.value");var Ot=Et.value.ListWithSubRange(Tt.valueObject,_t.valueObject);this.state.PushEvaluationStack(new j(Ot));break;case G.CommandType.ListRandom:var Pt=this.state.PopEvaluationStack();if(null===Pt)throw new P("Expected list for LIST_RANDOM");var Nt=Pt.value,At=null;if(null===Nt)throw d("list");if(0==Nt.Count)At=new O;else{for(var It=new nt(this.state.storySeed+this.state.previousRandom).next(),Ft=It%Nt.Count,xt=Nt.entries(),Wt=0;Wt<=Ft-1;Wt++)xt.next();var Vt=xt.next().value,Lt={Key:E.fromSerializedKey(Vt[0]),Value:Vt[1]};if(null===Lt.Key.originName)return d("randomItem.Key.originName");(At=new O(Lt.Key.originName,this)).Add(Lt.Key,Lt.Value),this.state.previousRandom=It}this.state.PushEvaluationStack(new j(At));break;default:this.Error("unhandled ControlCommand: "+h)}return!0}if(t instanceof K){var jt=t,Rt=this.state.PopEvaluationStack();return this.state.variablesState.Assign(jt,Rt),!0}if(t instanceof q){var Dt=t,Bt=null;if(null!=Dt.pathForCount){var Gt=this.state.VisitCountForContainer(Dt.containerForCount);Bt=new F(Gt)}else null==(Bt=this.state.variablesState.GetVariableWithName(Dt.name))&&(this.Warning("Variable not found: '"+Dt.name+"'. Using default value of 0 (false). This can happen with temporary variables if the declaration hasn't yet been hit. Globals are always given a default value on load if a value doesn't exist in the save state."),Bt=new F(0));return this.state.PushEvaluationStack(Bt),!0}if(t instanceof H){var Mt=t,Jt=this.state.PopEvaluationStack(Mt.numberOfParameters),Ut=Mt.Call(Jt);return this.state.PushEvaluationStack(Ut),!0}return!1}},{key:"ChoosePathString",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if(this.IfAsyncWeCant("call ChoosePathString right now"),null!==this.onChoosePathString&&this.onChoosePathString(t,n),e)this.ResetCallstack();else if(this.state.callStack.currentElement.type==k.Function){var i="",r=this.state.callStack.currentElement.currentPointer.container;throw null!=r&&(i="("+r.path.toString()+") "),new Error("Story was running a function "+i+"when you called ChoosePathString("+t+") - this is almost certainly not not what you want! Full stack trace: \n"+this.state.callStack.callStackTrace)}this.state.PassArgumentsToEvaluationStack(n),this.ChoosePath(new b(t))}},{key:"IfAsyncWeCant",value:function(t){if(this._asyncContinueActive)throw new Error("Can't "+t+". Story is in the middle of a ContinueAsync(). Make more ContinueAsync() calls or a single Continue() call beforehand.")}},{key:"ChoosePath",value:function(t){this.state.SetChosenPath(t,!(arguments.length>1&&void 0!==arguments[1])||arguments[1]),this.VisitChangedContainersDueToDivert()}},{key:"ChooseChoiceIndex",value:function(t){var e=this.currentChoices;this.Assert(t>=0&&t<e.length,"choice out of range");var n=e[t];return null!==this.onMakeChoice&&this.onMakeChoice(n),null===n.threadAtGeneration?d("choiceToChoose.threadAtGeneration"):null===n.targetPath?d("choiceToChoose.targetPath"):(this.state.callStack.currentThread=n.threadAtGeneration,void this.ChoosePath(n.targetPath))}},{key:"HasFunction",value:function(t){try{return null!=this.KnotContainerWithName(t)}catch(t){return!1}}},{key:"EvaluateFunction",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(null!==this.onEvaluateFunction&&this.onEvaluateFunction(t,e),this.IfAsyncWeCant("evaluate a function"),null==t)throw new Error("Function is null");if(""==t||""==t.trim())throw new Error("Function is empty or white space.");var i=this.KnotContainerWithName(t);if(null==i)throw new Error("Function doesn't exist: '"+t+"'");var r=[];r.push.apply(r,f(this.state.outputStream)),this._state.ResetOutput(),this.state.StartFunctionEvaluationFromGame(i,e);for(var a=new T;this.canContinue;)a.Append(this.Continue());var o=a.toString();this._state.ResetOutput(r);var s=this.state.CompleteFunctionEvaluationFromGame();return null!=this.onCompleteEvaluateFunction&&this.onCompleteEvaluateFunction(t,e,o,s),n?{returned:s,output:o}:s}},{key:"EvaluateExpression",value:function(t){var e=this.state.callStack.elements.length;this.state.callStack.Push(k.Tunnel),this._temporaryEvaluationContainer=t,this.state.GoToStart();var n=this.state.evaluationStack.length;return this.Continue(),this._temporaryEvaluationContainer=null,this.state.callStack.elements.length>e&&this.state.PopCallStack(),this.state.evaluationStack.length>n?this.state.PopEvaluationStack():null}},{key:"CallExternalFunction",value:function(t,e){if(null===t)return d("funcName");var n=this._externals.get(t),i=null,r=void 0!==n;if(!r||n.lookAheadSafe||null===this._stateSnapshotAtLastNewline){if(!r){if(this.allowExternalFunctionFallbacks)return i=this.KnotContainerWithName(t),this.Assert(null!==i,"Trying to call EXTERNAL function '"+t+"' which has not been bound, and fallback ink function could not be found."),this.state.callStack.Push(k.Function,void 0,this.state.outputStream.length),void(this.state.divertedPointer=M.StartOf(i));this.Assert(!1,"Trying to call EXTERNAL function '"+t+"' which has not been bound (and ink fallbacks disabled).")}for(var a=[],o=0;o<e;++o){var s=u(this.state.PopEvaluationStack(),A).valueObject;a.push(s)}a.reverse();var l=n.function(a),h=null;null!=l?(h=A.Create(l),this.Assert(null!==h,"Could not create ink value from returned object of type "+g(l))):h=new z,this.state.PushEvaluationStack(h)}else this._sawLookaheadUnsafeFunctionAfterNewline=!0}},{key:"BindExternalFunctionGeneral",value:function(t,e){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.IfAsyncWeCant("bind an external function"),this.Assert(!this._externals.has(t),"Function '"+t+"' has already been bound."),this._externals.set(t,{function:e,lookAheadSafe:n})}},{key:"TryCoerce",value:function(t){return t}},{key:"BindExternalFunction",value:function(t,e){var n=this,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.Assert(null!=e,"Can't bind a null function"),this.BindExternalFunctionGeneral(t,(function(t){n.Assert(t.length>=e.length,"External function expected "+e.length+" arguments");for(var i=[],r=0,a=t.length;r<a;r++)i[r]=n.TryCoerce(t[r]);return e.apply(null,i)}),i)}},{key:"UnbindExternalFunction",value:function(t){this.IfAsyncWeCant("unbind an external a function"),this.Assert(this._externals.has(t),"Function '"+t+"' has not been bound."),this._externals.delete(t)}},{key:"ValidateExternalBindings",value:function(){var t=null,i=null,r=arguments[1]||new Set;if(arguments[0]instanceof D&&(t=arguments[0]),arguments[0]instanceof _&&(i=arguments[0]),null===t&&null===i)if(this.ValidateExternalBindings(this._mainContentContainer,r),this._hasValidatedExternals=!0,0==r.size)this._hasValidatedExternals=!0;else{var a="Error: Missing function binding for external";a+=r.size>1?"s":"",a+=": '",a+=Array.from(r).join("', '"),a+="' ",this.Error(a+=this.allowExternalFunctionFallbacks?", and no fallback ink function found.":" (ink fallbacks disabled)")}else if(null!=t){var o,s=v(t.content);try{for(s.s();!(o=s.n()).done;){var u=o.value;null!=u&&u.hasValidName||this.ValidateExternalBindings(u,r)}}catch(t){s.e(t)}finally{s.f()}var l,h=v(t.namedContent);try{for(h.s();!(l=h.n()).done;){var c=n(l.value,2);this.ValidateExternalBindings(e(c[1],_),r)}}catch(t){h.e(t)}finally{h.f()}}else if(null!=i){var f=e(i,J);if(f&&f.isExternal){var p=f.targetPathString;if(null===p)return d("name");this._externals.has(p)||this.allowExternalFunctionFallbacks&&this.mainContentContainer.namedContent.has(p)||r.add(p)}}}},{key:"ObserveVariable",value:function(t,e){if(this.IfAsyncWeCant("observe a new variable"),null===this._variableObservers&&(this._variableObservers=new Map),!this.state.variablesState.GlobalVariableExistsWithName(t))throw new Error("Cannot observe variable '"+t+"' because it wasn't declared in the ink story.");this._variableObservers.has(t)?this._variableObservers.get(t).push(e):this._variableObservers.set(t,[e])}},{key:"ObserveVariables",value:function(t,e){for(var n=0,i=t.length;n<i;n++)this.ObserveVariable(t[n],e[n])}},{key:"RemoveVariableObserver",value:function(t,e){if(this.IfAsyncWeCant("remove a variable observer"),null!==this._variableObservers)if(null!=e){if(this._variableObservers.has(e))if(null!=t){var n=this._variableObservers.get(e);null!=n&&(n.splice(n.indexOf(t),1),0===n.length&&this._variableObservers.delete(e))}else this._variableObservers.delete(e)}else if(null!=t){var i,r=v(this._variableObservers.keys());try{for(r.s();!(i=r.n()).done;){var a=i.value,o=this._variableObservers.get(a);null!=o&&(o.splice(o.indexOf(t),1),0===o.length&&this._variableObservers.delete(a))}}catch(t){r.e(t)}finally{r.f()}}}},{key:"VariableStateDidChangeEvent",value:function(t,e){if(null!==this._variableObservers){var n=this._variableObservers.get(t);if(void 0!==n){if(!(e instanceof A))throw new Error("Tried to get the value of a variable that isn't a standard type");var i,r=u(e,A),a=v(n);try{for(a.s();!(i=a.n()).done;)(0,i.value)(t,r.valueObject)}catch(t){a.e(t)}finally{a.f()}}}}},{key:"globalTags",get:function(){return this.TagsAtStartOfFlowContainerWithPathString("")}},{key:"TagsForContentAtPath",value:function(t){return this.TagsAtStartOfFlowContainerWithPathString(t)}},{key:"TagsAtStartOfFlowContainerWithPathString",value:function(t){var n=new b(t),i=this.ContentAtPath(n).container;if(null===i)return d("flowContainer");for(;;){var r=i.content[0];if(!(r instanceof D))break;i=r}var a,o=!1,s=null,u=v(i.content);try{for(u.s();!(a=u.n()).done;){var l=a.value,h=e(l,G);if(null!=h)h.commandType==G.CommandType.BeginTag?o=!0:h.commandType==G.CommandType.EndTag&&(o=!1);else{if(!o)break;var c=e(l,W);null!==c?(null===s&&(s=[]),null!==c.value&&s.push(c.value)):this.Error("Tag contained non-text content. Only plain text is allowed when using globalTags or TagsAtContentPath. If you want to evaluate dynamic content, you need to use story.Continue().")}}}catch(t){u.e(t)}finally{u.f()}return s}},{key:"BuildStringOfHierarchy",value:function(){var t=new T;return this.mainContentContainer.BuildStringOfHierarchy(t,0,this.state.currentPointer.Resolve()),t.toString()}},{key:"BuildStringOfContainer",value:function(t){var e=new T;return t.BuildStringOfHierarchy(e,0,this.state.currentPointer.Resolve()),e.toString()}},{key:"NextContent",value:function(){if(this.state.previousPointer=this.state.currentPointer.copy(),(this.state.divertedPointer.isNull||(this.state.currentPointer=this.state.divertedPointer.copy(),this.state.divertedPointer=M.Null,this.VisitChangedContainersDueToDivert(),this.state.currentPointer.isNull))&&!this.IncrementContentPointer()){var t=!1;this.state.callStack.CanPop(k.Function)?(this.state.PopCallStack(k.Function),this.state.inExpressionEvaluation&&this.state.PushEvaluationStack(new z),t=!0):this.state.callStack.canPopThread?(this.state.callStack.PopThread(),t=!0):this.state.TryExitFunctionEvaluationFromGame(),t&&!this.state.currentPointer.isNull&&this.NextContent()}}},{key:"IncrementContentPointer",value:function(){var t=!0,n=this.state.callStack.currentElement.currentPointer.copy();if(n.index++,null===n.container)return d("pointer.container");for(;n.index>=n.container.content.length;){t=!1;var i=e(n.container.parent,D);if(i instanceof D==0)break;var r=i.content.indexOf(n.container);if(-1==r)break;if((n=new M(i,r)).index++,t=!0,null===n.container)return d("pointer.container")}return t||(n=M.Null),this.state.callStack.currentElement.currentPointer=n.copy(),t}},{key:"TryFollowDefaultInvisibleChoice",value:function(){var t=this._state.currentChoices,e=t.filter((function(t){return t.isInvisibleDefault}));if(0==e.length||t.length>e.length)return!1;var n=e[0];return null===n.targetPath?d("choice.targetPath"):null===n.threadAtGeneration?d("choice.threadAtGeneration"):(this.state.callStack.currentThread=n.threadAtGeneration,null!==this._stateSnapshotAtLastNewline&&(this.state.callStack.currentThread=this.state.callStack.ForkThread()),this.ChoosePath(n.targetPath,!1),!0)}},{key:"NextSequenceShuffleIndex",value:function(){var t=e(this.state.PopEvaluationStack(),F);if(!(t instanceof F))return this.Error("expected number of elements in sequence for shuffle index"),0;var n=this.state.currentPointer.container;if(null===n)return d("seqContainer");if(null===t.value)return d("numElementsIntVal.value");var i=t.value,r=u(this.state.PopEvaluationStack(),F).value;if(null===r)return d("seqCount");for(var a=r/i,o=r%i,s=n.path.toString(),l=0,h=0,c=s.length;h<c;h++)l+=s.charCodeAt(h)||0;for(var f=new nt(Math.floor(l+a+this.state.storySeed)),v=[],p=0;p<i;++p)v.push(p);for(var y=0;y<=o;++y){var m=f.next()%v.length,g=v[m];if(v.splice(m,1),y==o)return g}throw new Error("Should never reach here")}},{key:"Error",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=new P(t);throw n.useEndLineNumber=e,n}},{key:"Warning",value:function(t){this.AddError(t,!0)}},{key:"AddError",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this.currentDebugMetadata,i=e?"WARNING":"ERROR";this.state.AddError(t=null!=n?"RUNTIME "+i+": '"+n.fileName+"' line "+(arguments.length>2&&void 0!==arguments[2]&&arguments[2]?n.endLineNumber:n.startLineNumber)+": "+t:this.state.currentPointer.isNull?"RUNTIME "+i+": "+t:"RUNTIME "+i+": ("+this.state.currentPointer+"): "+t,e),e||this.state.ForceEnd()}},{key:"Assert",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(0==t)throw null==e&&(e="Story assert"),new Error(e+" "+this.currentDebugMetadata)}},{key:"currentDebugMetadata",get:function(){var t,e=this.state.currentPointer;if(!e.isNull&&null!==e.Resolve()&&null!==(t=e.Resolve().debugMetadata))return t;for(var n=this.state.callStack.elements.length-1;n>=0;--n)if(!(e=this.state.callStack.elements[n].currentPointer).isNull&&null!==e.Resolve()&&null!==(t=e.Resolve().debugMetadata))return t;for(var i=this.state.outputStream.length-1;i>=0;--i)if(null!==(t=this.state.outputStream[i].debugMetadata))return t;return null}},{key:"mainContentContainer",get:function(){return this._temporaryEvaluationContainer?this._temporaryEvaluationContainer:this._mainContentContainer}}]),a}(_);ut.inkVersionCurrent=21,function(t){var e;(e=t.OutputStateChange||(t.OutputStateChange={}))[e.NoChange=0]="NoChange",e[e.ExtendedBeyondNewline=1]="ExtendedBeyondNewline",e[e.NewlineRemoved=2]="NewlineRemoved"}(ut||(ut={})),t.InkList=O,t.Story=ut,Object.defineProperty(t,"__esModule",{value:!0})},"object"==g(e)&&void 0!==t?C(e):void 0===(k="function"==typeof(S=C)?S.apply(e,[e]):S)||(t.exports=k)}}]);
//# sourceMappingURL=inkjs.chunk.93416.js.map